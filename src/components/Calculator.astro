---
/*
Calculator.astro — generator sizing (continuous amps + surge), with LMS + ZIP-based derating

Highlights
- CSV loader uses safe newline splitter (no regex)
- Appliances list (+ NEC lighting/branch circuits)
- AC rows (tons->prefill amps, editable)
- Heating (resistance or HP supplemental)
- EV chargers (amps @ 240 V), inline ✕ on same row
- LMS: Appliances, each AC row, Heating, and each EV row are “shed-able”
  • Appliances/EV: sum unmanaged + largest managed
  • AC: sum unmanaged + largest managed condenser
  • Heating: competes seasonally with AC (we still take seasonal max)
- Liquid-cooled advisory banner in results
- ZIP -> elevation & temp derating (air-cooled vs liquid-cooled rules)
- Vanilla JS only (no React imports)
*/
---
<div class="box" id="gen-calculator">
  <div class="calc-grid">
    <div class="inputs">
      <label for="scope"><strong>What do you want to power?</strong></label>
      <select id="scope">
        <option value="essentials">Essentials (fridge, lights, furnace blower)</option>
        <option value="most">Most of house (kitchen + some HVAC)</option>
        <option value="whole">Whole house (unrestricted typical use)</option>
      </select>

      <div class="controls-row" style="margin-top:.5rem;align-items:end;">
        <div>
          <label for="zip" class="lbl">Home ZIP code (US, 5 digits)</label>
          <input id="zip" class="fld" type="text" inputmode="numeric" maxlength="5" placeholder="e.g., 19087">
          <small class="muted">
            Used to estimate elevation &amp; typical summer high. Leave blank to assume sea level &amp; 60&nbsp;°F.
          </small>
        </div>
        <div></div>
      </div>

      <div class="controls-row" style="margin-top:.5rem;align-items:end;">
        <div>
          <label for="sqft" class="lbl">Home square footage (incl. garage &amp; basement)</label>
          <input id="sqft" class="fld" type="number" min="0" step="50" placeholder="e.g., 2400">
          <small style="color:#666">NEC general lighting load = 3 watts per sq ft × this number. (NEC&nbsp;2023 includes garage &amp; basement.)</small>
        </div>
      </div>

      <!-- Appliances (collapsible) -->
      <div id="appliance-header" style="display:flex;justify-content:space-between;align-items:center;margin-top:0.75rem;">
        <div id="appliance-summary" style="font-size:.95rem;color:#555">
          ✅ Preset applied. <span id="summary-count">0</span> items selected.
          <button id="toggle-appliances" type="button" aria-controls="appliance-panel" aria-expanded="false" style="margin-left:.5rem;border:0;background:transparent;color:#0b6;font-weight:600;cursor:pointer;">Show details ▾</button>
        </div>
      </div>

      <div id="appliance-panel" data-open="0" style="overflow:hidden;max-height:0;transition:max-height .28s ease;will-change:max-height;margin-top:.25rem;">
        <!-- NEC required small-appliance and laundry circuits -->
        <div id="nec-circuits" style="display:grid;grid-template-columns:1fr auto auto;gap:.5rem 1rem;align-items:center;margin:.5rem 0 .75rem;">
          <div><strong>Small-appliance circuits</strong> <small style="color:#666">(NEC, 1500 W each)</small></div>
          <label for="smallQty" style="justify-self:end;color:#555">Qty</label>
          <input id="smallQty" type="number" min="0" step="1" value="2" style="width:7ch;text-align:right;">

          <div><strong>Laundry circuits</strong> <small style="color:#666">(NEC, 1500 W each)</small></div>
          <label for="laundryQty" style="justify-self:end;color:#555">Qty</label>
          <input id="laundryQty" type="number" min="0" step="1" value="1" style="width:7ch;text-align:right;">
        </div>

        <div id="appliance-list" style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem 1rem"></div>
      </div>

      <hr style="margin:1rem 0">

      <!-- Air Conditioning -->
      <div id="ac-section">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem">
          <strong>Air conditioning (optional)</strong>
          <div style="display:flex;gap:.5rem;align-items:center">
            <button id="toggle-ac" type="button" aria-controls="ac-panel" aria-expanded="false" style="border:0;background:transparent;color:#0a7e51;font-weight:600;cursor:pointer;">Show details ▾</button>
            <button id="add-ac" type="button">+ Add AC system</button>
          </div>
        </div>
        <small style="color:#555">Add one row per condenser (e.g., 3-ton up, 2-ton down).</small>
        <div id="ac-panel" data-open="0" style="overflow:hidden;max-height:0;transition:max-height .28s ease;will-change:max-height;margin-top:.5rem;">
          <div id="ac-rows" style="display:flex;flex-direction:column;gap:.75rem;margin-top:.5rem"></div>
        </div>
      </div>

      <!-- Heating -->
      <div id="heat-section" style="margin-top:1rem;">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem">
          <strong>Heating (optional)</strong>
          <button id="toggle-heat" type="button" aria-controls="heat-panel" aria-expanded="false" style="border:0;background:transparent;color:#0a7e51;font-weight:600;cursor:pointer;">Show details ▾</button>
        </div>
        <div id="heat-panel" data-open="0" style="overflow:hidden;max-height:0;transition:max-height .28s ease;will-change:max-height;margin-top:.5rem;">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;align-items:center">
            <label for="heat-type">Type</label>
            <select id="heat-type">
              <option value="none">None</option>
              <option value="resistance">Electric resistance (furnace/baseboards)</option>
              <option value="hp_supp">Heat pump + electric supplemental</option>
            </select>
            <label for="heat-kw">kW (if applicable)</label>
            <input id="heat-kw" type="number" min="0" step="0.5" placeholder="e.g., 10">
          </div>
          <small style="color:#555">Per NEC, we use the larger of heating or A/C. For heat pumps, we add 65% of supplemental heat.</small>
        </div>
      </div>

      <!-- EV Chargers -->
      <div id="ev-section" style="margin-top:1rem;">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem">
          <strong>EV chargers (optional)</strong>
          <div style="display:flex;gap:.5rem;align-items:center">
            <button id="toggle-ev" type="button" aria-controls="ev-panel" aria-expanded="false" style="border:0;background:transparent;color:#0a7e51;font-weight:600;cursor:pointer;">Show details ▾</button>
            <button id="add-ev" type="button">+ Add EV charger</button>
          </div>
        </div>
        <small style="color:#555">Included at 100% like A/C. Enter charging/breaker amps at 240 V.</small>
        <div id="ev-panel" data-open="0" style="overflow:hidden;max-height:0;transition:max-height .28s ease;will-change:max-height;margin-top:.5rem;">
          <div id="ev-rows" style="display:flex;flex-direction:column;gap:.75rem;margin-top:.5rem"></div>
        </div>
      </div>

      <!-- Max-start (surge) -->
      <div id="maxstart-section" style="margin-top:1rem;">
        <strong>Appliance w/max starting amps</strong>
        <div class="controls-row" style="grid-template-columns:1fr 1fr;align-items:end;margin-top:.5rem;">
          <div>
            <label for="ms-start-amps" class="lbl">Starting amps</label>
            <input id="ms-start-amps" type="number" min="0" step="0.1" placeholder="e.g., 40">
          </div>
          <div>
            <label for="ms-run-amps" class="lbl">Running amps</label>
            <input id="ms-run-amps" type="number" min="0" step="0.1" placeholder="e.g., 8">
          </div>
        </div>
        <div class="controls-row" style="grid-template-columns:1fr 1fr; margin-top:.25rem;">
          <div>
            <label for="ms-volts" class="lbl">Voltage</label>
            <select id="ms-volts">
              <option value="120" selected>120 V</option>
              <option value="240">240 V</option>
            </select>
          </div>
          <div>
            <label for="ms-soft" class="lbl">Soft Starter</label>
            <select id="ms-soft">
              <option value="no" selected>No</option>
              <option value="yes">Yes</option>
            </select>
          </div>
        </div>
        <small class="muted">Used to adjust peak (surge) amps for the recommendation.</small>
      </div>

      <!-- LMS -->
      <div class="controls-row" style="margin-top:1.25rem;grid-template-columns: 1fr 1fr;">
        <div>
          <label for="lms-enable" class="lbl">Load Management System (LMS)</label>
          <select id="lms-enable">
            <option value="no" selected>No</option>
            <option value="yes">Yes</option>
          </select>
          <small class="muted">If enabled, we count the sum of unmanaged + the <em>largest</em> managed item for each category.</small>
        </div>
        <div></div>
      </div>

      <div id="lms-section" data-open="0" style="overflow:hidden;max-height:0;transition:max-height .28s ease;will-change:max-height;margin-top:.5rem;border:1px solid #e6ebf2;border-radius:10px;">
        <div style="padding:.75rem;display:flex;justify-content:space-between;align-items:center;gap:.5rem;">
          <div class="lbl" style="margin:0">LMS items — <span id="lms-summary">No LMS items selected</span></div>
          <button id="toggle-lms" type="button" aria-controls="lms-panel" aria-expanded="false" style="border:0;background:transparent;color:#0a7e51;font-weight:600;cursor:pointer;">Show details ▾</button>
        </div>
        <div id="lms-panel" style="padding:.5rem .75rem .75rem">
          <small class="muted">Select items to manage (shed/sequence). Only the <em>largest</em> managed item per category is counted with unmanaged.</small>
          <div id="lms-list" style="margin-top:.5rem;display:grid;grid-template-columns:1fr 1fr;gap:.5rem 1rem"></div>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem;margin-top:.5rem;">
            <div class="mini-card"><div class="mini-label">Managed count</div><div class="mini-val" id="lms-count">0</div></div>
            <div class="mini-card"><div class="mini-label">Largest managed (Appl.)</div><div class="mini-val" id="lms-max-general">0 W</div></div>
            <div class="mini-card"><div class="mini-label">Largest managed (AC/EV)</div><div class="mini-val" id="lms-max-others">0 W</div></div>
          </div>
        </div>
      </div>

      <!-- Fuel & buffer -->
      <div class="controls-row">
        <label for="fuelType" class="lbl">Fuel type</label>
        <select id="fuelType">
          <option value="lp" selected>LP (propane)</option>
          <option value="ng">Natural gas</option>
        </select>
      </div>
      <div class="controls-row">
        <label for="bufferPct" class="lbl">Headroom buffer (%)</label>
        <input id="bufferPct" type="number" min="0" max="50" step="1" value="20" class="fld">
      </div>

      <hr>
    </div>

    <aside class="summary-card" aria-live="polite">
      <div id="results">
        <h3 class="summary-title" style="margin:.25rem 0 .5rem">Recommended generator size</h3>
        <p class="summary-big" style="font-size:1.4rem;line-height:1.2;margin:.25rem 0 .75rem"><span id="rec">—</span></p>
        <div id="lc-alert" style="display:none;margin:.5rem 0;padding:.5rem .75rem;border-left:4px solid #b45309;background:#FFF7ED;color:#92400E;border-radius:6px;">
          Consider a load management system to reduce recommended generator size.
        </div>
        <p style="margin:.25rem 0"><strong>Planning load:</strong> <span id="runW">0</span> W</p>
        <p style="margin:.25rem 0"><strong>Needed amps (with buffer):</strong> <span id="needA">0</span> A</p>
        <p style="margin:.25rem 0"><strong>Peak amps (with max-start):</strong> <span id="peakA">0</span> A</p>
        <small id="assumption-note" style="color:#666;display:block;margin-top:.25rem">
          Running amps = watts ÷ 240. Needed amps = running amps ÷ (1 − headroom%). Peak includes max-start swap (soft starter cuts start amps ~50%).
        </small>
        <small id="env-note" style="color:#666;display:block;margin-top:.25rem"></small>
      </div>
    </aside>
  </div>

  <p style="margin-top:1rem;color:#555">
    Heads up: This calculator is for general information only. Always consult a licensed electrician before buying or installing a generator.
  </p>
</div>

<style>
  .box { background:#fff; padding:1.5rem; border-radius:12px; box-shadow:0 3px 14px rgba(0,0,0,.06); max-width:720px; margin:0 auto 1.5rem; }
  label { display:block; margin-top:1rem; font-weight:600; }
  input, select { width:100%; padding:.6rem .7rem; margin-top:.35rem; border:1px solid #cfd6df; border-radius:8px; font-size:1rem; background:#fff; }
  .controls-row { display:grid; grid-template-columns:1fr 1fr; gap:.5rem .75rem; margin-top:1rem; align-items:center; }
  @media (max-width:560px){ .controls-row { grid-template-columns:1fr; } }
  .watt-input { width:7ch; min-width:7ch; text-align:right; padding:.35rem .5rem; margin:0; }
  .appliance-row { display:flex; align-items:center; gap:.5rem; }
  .appliance-row .name { flex:1 1 auto; min-width:0; }
  .calc-grid{display:grid;gap:1rem}
  @media(min-width:900px){.calc-grid{grid-template-columns:1fr 320px}}
  .summary-card{position:sticky;top:1rem;align-self:start;background:#fff;border:1px solid #e6ebf2;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.06);padding:1rem}
  .summary-card p{margin:.25rem 0}
  #toggle-appliances{color:#0a7e51}
  #toggle-appliances:hover{text-decoration:underline}
  .muted{ color:#6b7280 }
  .ac-subgrid{ display:grid; grid-template-columns: 1fr; gap:.5rem .75rem; margin-top:.35rem; }
  .ac-subgrid input{ width:9ch; text-align:right; }
  .mini-card{background:#fff;border:1px solid #eef2f6;border-radius:10px;padding:.5rem}
  .mini-label{font-size:.75rem;color:#6b7280}
  .mini-val{font-weight:700}
</style>

<script>
window.addEventListener('DOMContentLoaded', () => {
  // --------- DATA ----------
  const APPLIANCES = [
    { id:'well',        name:'Well pump (3/4 hp)',              run:1500, defaultScopes:['most','whole'] },
    { id:'sump',        name:'Sump pump (1/2 hp)',              run:900,  defaultScopes:['essentials','most','whole'] },
    { id:'freezer',     name:'Chest freezer',                   run:120,  defaultScopes:['most','whole'] },
    { id:'microwave',   name:'Microwave (1.0–1.2 kW)',          run:1200, defaultScopes:['most','whole'] },
    { id:'disposal',    name:'Garbage disposal',                run:700,  defaultScopes:['most','whole'] },
    { id:'dishwasher',  name:'Dishwasher',                      run:1500, defaultScopes:['most','whole'] },
    { id:'elecRange',   name:'Electric range (cooktop+oven)',   run:8000, defaultScopes:['whole'] },
    { id:'wallOven',    name:'Wall-mounted oven (single)',      run:3000, defaultScopes:['whole'] },
    { id:'cooktop',     name:'Counter cooktop (electric)',      run:3500, defaultScopes:['whole'] },
    { id:'waterHeater', name:'Electric water heater (tank)',    run:4500, defaultScopes:['whole'] },
    { id:'elecDryer',   name:'Electric clothes dryer',          run:5500, defaultScopes:['whole'] },
    { id:'gdoor',       name:'Garage door opener',              run:500,  defaultScopes:['most','whole'] },
    { id:'septic',      name:'Septic grinder pump',             run:1000, defaultScopes:['most','whole'] },
    { id:'hottub',      name:'Hot tub / spa',                   run:10000,defaultScopes:['whole'] },
    { id:'pool',        name:'Pool pump (1–1.5 hp)',            run:1200, defaultScopes:[] },
    { id:'other',       name:'Other (enter watts)',             run:0,    defaultScopes:[] },
    { id:'fridge',      name:'Refrigerator',                    run:150,  defaultScopes:['essentials','most','whole'] },
    { id:'furnace',     name:'Furnace blower (gas/propane)',    run:600,  defaultScopes:['essentials','most','whole'] }
  ];
  const RUN_W_PER_TON = { standard:1100, inverter:750 };
  const AC_VOLTS = 240;

  // Fallback generator table (amps @ 240)
  let GEN_TABLE = [
    { label:'~10 kW standby', amps_lp:42, amps_ng:42, max_surge:55, cooling:'Air' },
    { label:'~14 kW standby', amps_lp:58, amps_ng:54, max_surge:75, cooling:'Air' },
    { label:'~18 kW standby', amps_lp:75, amps_ng:70, max_surge:90, cooling:'Air' },
    { label:'~22 kW standby', amps_lp:92, amps_ng:81, max_surge:110, cooling:'Air' },
    { label:'~24 kW standby', amps_lp:100, amps_ng:100, max_surge:120, cooling:'Air' },
    { label:'~26 kW standby', amps_lp:108, amps_ng:108, max_surge:130, cooling:'Air' }
  ];

  // ZIP -> { elevFt, tempF }
  const ZIP_TABLE = new Map();

  // --------- CSV loader (safe newline splitter) ----------
  async function tryLoadCsv() {
    const paths = ['/generator-amps.csv','/data/generator-amps.csv','/generator_amps.csv','/public/generator_amps.csv'];
    for (const p of paths) {
      try {
        const res = await fetch(p, { cache:'no-store' });
        if (!res.ok) continue;
        const text = await res.text();
        const rows = text.split('\n').map(l => (l.endsWith('\r') ? l.slice(0,-1) : l));
        if (!rows.length) continue;

        const header = rows.shift().split(',').map(s => s.trim().toLowerCase());
        const iLabel=header.indexOf('label'), iLP=header.indexOf('amps_lp'), iNG=header.indexOf('amps_ng'), iSurge=header.indexOf('max_surge'), iCooling=header.indexOf('cooling');
        if (iLabel<0||iLP<0||iNG<0||iSurge<0) continue;

        const parsed = rows.map(r=>{
          if (!r.trim()) return null;
          const c=r.split(',').map(s=>s.trim());
          return { label:c[iLabel], amps_lp:Number(c[iLP]), amps_ng:Number(c[iNG]), max_surge:Number(c[iSurge]), cooling:iCooling>=0?c[iCooling]:undefined };
        }).filter(x=>x && x.label && Number.isFinite(x.amps_lp) && Number.isFinite(x.amps_ng) && Number.isFinite(x.max_surge));

        if (parsed.length) GEN_TABLE = parsed.sort((a,b)=>Math.min(a.amps_lp,a.amps_ng)-Math.min(b.amps_lp,b.amps_ng));
        break;
      } catch { /* ignore */ }
    }
  }

  async function tryLoadZipCsv() {
    const paths = ['/zip_elevation_temp.csv','/data/zip_elevation_temp.csv','/public/zip_elevation_temp.csv'];
    for (const p of paths) {
      try {
        const res = await fetch(p, { cache:'no-store' });
        if (!res.ok) continue;
        const text = await res.text();
        const rows = text.split('\n').map(l => (l.endsWith('\r') ? l.slice(0,-1) : l));
        if (!rows.length) continue;

        const header = rows.shift().split(',').map(s => s.trim().toLowerCase());
        const iZip = header.indexOf('zip');
        const iElevM = header.indexOf('elevation_m');
        const iElevFt = iElevM < 0 ? header.indexOf('elevation_ft') : -1;
        const iElevGeneric = (iElevM < 0 && iElevFt < 0) ? header.indexOf('elevation') : -1;
        const iTemp = header.findIndex(h => h === 'temp' || h === 'temperature' || h === 'avg_temp' || h === 'avg_high');

        if (iZip < 0 || iTemp < 0 || (iElevM < 0 && iElevFt < 0 && iElevGeneric < 0)) continue;

        rows.forEach(r => {
          if (!r.trim()) return;
          const c = r.split(',').map(s => s.trim());
          const rawZip = c[iZip];
          if (!rawZip) return;
          let zipStr = String(rawZip).replace(/\D/g,'');
          if (!zipStr) return;
          zipStr = zipStr.padStart(5,'0').slice(-5);

          const elevRaw = c[iElevM >= 0 ? iElevM : (iElevFt >= 0 ? iElevFt : iElevGeneric)];
          const tempRaw = c[iTemp];
          const elevVal = parseFloat(elevRaw);
          const tempVal = parseFloat(tempRaw);
          if (!Number.isFinite(elevVal) || !Number.isFinite(tempVal)) return;

          // If elevation_m present, convert meters -> feet; otherwise assume feet
          const elevFt = iElevM >= 0 ? elevVal * 3.28084 : elevVal;

          ZIP_TABLE.set(zipStr, {
            elevFt,
            tempF: tempVal
          });
        });

        if (ZIP_TABLE.size) break;
      } catch { /* ignore */ }
    }
  }

  // --------- Elements ----------
  const el = id => document.getElementById(id);
  const scopeEl=el('scope'),
        listEl=el('appliance-list'),
        runWEl=el('runW'),
        needAEl=el('needA'),
        peakAEl=el('peakA');
  const sqftEl=el('sqft'),
        smallQtyEl=el('smallQty'),
        laundryQtyEl=el('laundryQty'),
        recEl=el('rec'),
        bufferPctEl=el('bufferPct'),
        fuelEl=el('fuelType');
  const acRowsEl=el('ac-rows'),
        addAcBtn=el('add-ac'),
        addEvBtn=el('add-ev');
  const heatTypeEl=el('heat-type'),
        heatKwEl=el('heat-kw');
  const acPanel=el('ac-panel'),
        heatPanel=el('heat-panel'),
        evPanel=el('ev-panel');
  const toggleAc=el('toggle-ac'),
        toggleHeat=el('toggle-heat'),
        toggleEv=el('toggle-ev');
  const panel=el('appliance-panel'),
        toggleBtn=el('toggle-appliances'),
        summaryCount=el('summary-count');

  const msStartAmpsEl=el('ms-start-amps'),
        msRunAmpsEl=el('ms-run-amps'),
        msVoltsEl=el('ms-volts'),
        msSoftEl=el('ms-soft');

  const zipEl = el('zip');
  const envNoteEl = el('env-note');

  // LMS refs
  const lmsEnableEl=el('lms-enable'),
        lmsSectionEl=el('lms-section'),
        lmsToggleEl=el('toggle-lms'),
        lmsPanelEl=el('lms-panel'),
        lmsListEl=el('lms-list');
  const lmsSummaryEl=el('lms-summary'),
        lmsCountEl=el('lms-count'),
        lmsMaxGeneralEl=el('lms-max-general'),
        lmsMaxOthersEl=el('lms-max-others');

  // --------- Build Appliance rows ----------
  APPLIANCES.forEach(a=>{
    const wrap=document.createElement('label'); wrap.className='appliance-row';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.id='cb_'+a.id;
    const name=document.createElement('span'); name.className='name'; name.textContent=a.name;
    const unit=document.createElement('small'); unit.textContent=' (W run)';
    const run=document.createElement('input'); run.type='number'; run.id='run_'+a.id; run.className='watt-input'; run.min='0'; run.step='10'; run.value=a.run;
    wrap.append(cb,name,unit,run); listEl.appendChild(wrap);
    run.addEventListener('input', ()=>{ recalc(); refreshLmsListDisabled(); });
  });

  // --------- LMS list builders ----------
  function buildLmsList(){
    lmsListEl.innerHTML='';

    // Appliances (non-AC)
    APPLIANCES.forEach(a=>{
      const row=document.createElement('label'); row.className='appliance-row';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.id='lms_'+a.id;
      const nm=document.createElement('span'); nm.className='name'; nm.textContent=a.name;
      const mt=document.createElement('small'); mt.id='lmsmeta_'+a.id; mt.textContent=' (0 W run)';
      row.append(cb,nm,mt); lmsListEl.appendChild(row);
      cb.addEventListener('change', recalc);
    });

    // AC header + rows
    const acHeader=document.createElement('div'); acHeader.style.cssText='grid-column:1/-1;margin-top:.5rem;color:#555;font-weight:600'; acHeader.textContent='A/C units';
    lmsListEl.appendChild(acHeader);
    Array.from(acRowsEl.querySelectorAll('.ac-row')).forEach((row,i)=>{
      const r=document.createElement('label'); r.className='appliance-row';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.id=`lms_ac_${i}`;
      const nm=document.createElement('span'); nm.className='name'; nm.textContent=`Condenser ${i+1}`;
      const mt=document.createElement('small'); mt.id=`lmsmeta_ac_${i}`; mt.textContent=' (0 W run)';
      r.append(cb,nm,mt); lmsListEl.appendChild(r);
      cb.addEventListener('change', recalc);
    });

    // Heating
    const heatRow=document.createElement('label'); heatRow.className='appliance-row';
    const heatCb=document.createElement('input'); heatCb.type='checkbox'; heatCb.id='lms_heat';
    const heatNm=document.createElement('span'); heatNm.className='name'; heatNm.textContent='Heating';
    const heatMt=document.createElement('small'); heatMt.id='lmsmeta_heat'; heatMt.textContent=' (0 W run)';
    heatRow.append(heatCb,heatNm,heatMt); lmsListEl.appendChild(heatRow);
    heatCb.addEventListener('change', recalc);

    // EV header + rows
    const evHeader=document.createElement('div'); evHeader.style.cssText='grid-column:1/-1;margin-top:.5rem;color:#555;font-weight:600'; evHeader.textContent='EV chargers';
    lmsListEl.appendChild(evHeader);
    const evRows=Array.from((evPanel?.querySelector('#ev-rows')||document.createElement('div')).querySelectorAll('.ev-row'));
    evRows.forEach((row,i)=>{
      const r=document.createElement('label'); r.className='appliance-row';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.id=`lms_ev_${i}`;
      const nm=document.createElement('span'); nm.className='name'; nm.textContent=`EV charger ${i+1}`;
      const mt=document.createElement('small'); mt.id=`lmsmeta_ev_${i}`; mt.textContent=' (0 W run)';
      r.append(cb,nm,mt); lmsListEl.appendChild(r);
      cb.addEventListener('change', recalc);
    });

    refreshLmsListDisabled();
  }

  function refreshLmsListDisabled(){
    let managedCount=0;

    // Appliances
    APPLIANCES.forEach(a=>{
      const sel=el('cb_'+a.id), lms=el('lms_'+a.id), meta=el('lmsmeta_'+a.id), runEl=el('run_'+a.id);
      const on=!!(sel && sel.checked);
      const run=Math.max(0, parseInt(runEl?.value||'0',10) || 0);
      if (lms){
        lms.disabled = !on || (lmsEnableEl?.value!=='yes');
        if (!on) lms.checked=false;
        if (meta) meta.textContent=` (${run.toLocaleString()} W run)`;
        if (lms.checked) managedCount++;
      }
    });

    // AC rows
    Array.from(acRowsEl.querySelectorAll('.ac-row')).forEach((row,i)=>{
      const input=row.querySelector('.ac-subgrid input[type="number"]');
      const runA=input ? parseFloat(input.value||'0')||0 : 0;
      const runW=Math.round(runA*240);
      const lms=el(`lms_ac_${i}`), meta=el(`lmsmeta_ac_${i}`);
      if (lms){
        lms.disabled=(lmsEnableEl?.value!=='yes');
        if (meta) meta.textContent=` (${runW.toLocaleString()} W run)`;
        if (lms.checked) managedCount++;
      }
    });

    // Heating (meta = supplemental portion if HP)
    const heatCb=el('lms_heat'), heatMeta=el('lmsmeta_heat');
    if (heatCb){
      const type=heatTypeEl?.value||'none';
      const kw=parseFloat(heatKwEl?.value||'0')||0;
      let heatW=0;
      if (type==='resistance') heatW=Math.round(kw*1000);
      if (type==='hp_supp') heatW=Math.round(kw*1000*0.65);
      heatCb.disabled=(type==='none') || (lmsEnableEl?.value!=='yes');
      if (type==='none') heatCb.checked=false;
      if (heatMeta) heatMeta.textContent=` (${heatW.toLocaleString()} W run)`;
      if (heatCb.checked) managedCount++;
    }

    // EV rows
    const evRows=Array.from((evPanel?.querySelector('#ev-rows')||document.createElement('div')).querySelectorAll('.ev-row'));
    evRows.forEach((row,i)=>{
      const input=row.querySelector('input[type="number"]');
      const amps=input ? parseFloat(input.value||'0')||0 : 0;
      const runW=Math.round(amps*240);
      const lms=el(`lms_ev_${i}`), meta=el(`lmsmeta_ev_${i}`);
      if (lms){
        lms.disabled=(lmsEnableEl?.value!=='yes');
        if (meta) meta.textContent=` (${runW.toLocaleString()} W run)`;
        if (lms.checked) managedCount++;
      }
    });

    lmsSummaryEl.textContent = managedCount ? `${managedCount} item(s) selected` : 'No LMS items selected';
    lmsCountEl.textContent = String(managedCount);
    if (lmsSectionEl?.getAttribute('data-open')==='1') lmsSectionEl.style.maxHeight = lmsSectionEl.scrollHeight + 'px';
  }

  // --------- Responsive/grid helpers ----------
  const media=window.matchMedia('(max-width:520px)');
  function applyGrid(){
    listEl.style.gridTemplateColumns = media.matches ? '1fr' : '1fr 1fr';
    if (lmsListEl) lmsListEl.style.gridTemplateColumns = media.matches ? '1fr' : '1fr 1fr';
  }
  applyGrid();
  if (media.addEventListener) media.addEventListener('change', applyGrid); else if (media.addListener) media.addListener(applyGrid);

  // Collapsible helpers
  let open=false;
  function setPanel(on){ open=on; panel.setAttribute('data-open',on?'1':'0'); toggleBtn.setAttribute('aria-expanded',on?'true':'false'); panel.style.maxHeight=on?panel.scrollHeight+'px':'0'; toggleBtn.textContent=on?'Hide details ▴':'Show details ▾'; }
  function setSection(panelEl,toggleEl,on){ if(!panelEl||!toggleEl) return; panelEl.setAttribute('data-open',on?'1':'0'); toggleEl.setAttribute('aria-expanded',on?'true':'false'); panelEl.style.maxHeight=on?panelEl.scrollHeight+'px':'0'; toggleEl.textContent=on?'Hide details ▴':'Show details ▾'; }
  toggleBtn.addEventListener('click', ()=>setPanel(!open));
  toggleAc?.addEventListener('click', ()=>setSection(acPanel,toggleAc,(acPanel?.getAttribute('data-open')!=='1')));
  toggleHeat?.addEventListener('click', ()=>setSection(heatPanel,toggleHeat,(heatPanel?.getAttribute('data-open')!=='1')));
  toggleEv?.addEventListener('click', ()=>setSection(evPanel,toggleEv,(evPanel?.getAttribute('data-open')!=='1')));
  lmsToggleEl?.addEventListener('click', ()=>setSection(lmsPanelEl,lmsToggleEl,(lmsSectionEl?.getAttribute('data-open')!=='1')));

  // --------- AC rows ----------
  function prefillRunAmps(tons,type){ const runW=Math.max(0,tons)*(RUN_W_PER_TON[type]||RUN_W_PER_TON.standard); return Math.round((runW/AC_VOLTS)*10)/10; }
  function addAcRow(preset={tons:2.5,type:'standard'}){
    if (acRowsEl.children.length>=3) return;
    const row=document.createElement('div'); row.className='ac-row';
    row.style.display='grid'; row.style.gridTemplateColumns='1fr 1fr auto'; row.style.gap='.5rem'; row.style.alignItems='center';
    row.style.padding='.25rem .25rem .5rem'; row.style.border='1px solid #eef2f6'; row.style.borderRadius='8px';

    const tonSel=document.createElement('select');
    [1.5,2,2.5,3,3.5,4,5].forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=`${t} ton`; tonSel.appendChild(o); });
    tonSel.value=preset.tons;

    const typeSel=document.createElement('select');
    [{v:'standard',n:'Standard (single-stage)'},{v:'inverter',n:'High-efficiency (inverter)'}].forEach(o=>{ const op=document.createElement('option'); op.value=o.v; op.textContent=o.n; typeSel.appendChild(op); });
    typeSel.value=preset.type;

    const delBtn=document.createElement('button'); delBtn.type='button'; delBtn.textContent='✕'; delBtn.title='Remove'; delBtn.style.minWidth='2rem';

    const sub=document.createElement('div'); sub.className='ac-subgrid'; sub.style.gridColumn='1 / -1';
    const runLbl=document.createElement('label'); runLbl.textContent='Running amps';
    const runA=document.createElement('input'); runA.type='number'; runA.step='0.1'; runA.min='0';
    sub.append(runLbl,runA);

    row.append(tonSel, typeSel, delBtn, sub); acRowsEl.appendChild(row);

    function refreshDefault(){ runA.value=prefillRunAmps(parseFloat(tonSel.value)||0, typeSel.value); }
    refreshDefault();

    const recalcBound=recalc.bind(null);
    tonSel.addEventListener('change', ()=>{ refreshDefault(); recalcBound(); refreshLmsListDisabled(); });
    typeSel.addEventListener('change', ()=>{ refreshDefault(); recalcBound(); refreshLmsListDisabled(); });
    runA.addEventListener('input', ()=>{ recalcBound(); refreshLmsListDisabled(); });
    delBtn.addEventListener('click', ()=>{ row.remove(); buildLmsList(); recalc(); });
  }

  // --------- EV rows ----------
  function addEvRow(preset={amps:40}){
    const row=document.createElement('div'); row.className='ev-row';
    row.style.display='grid'; row.style.gridTemplateColumns='auto auto 1fr auto'; row.style.gap='.5rem'; row.style.alignItems='center';
    row.style.padding='.25rem .5rem'; row.style.border='1px solid #eef2f6'; row.style.borderRadius='8px';

    const ampsLbl=document.createElement('label'); ampsLbl.textContent='Charger amps (240 V)';
    const ampsInp=document.createElement('input'); ampsInp.type='number'; ampsInp.step='1'; ampsInp.min='6'; ampsInp.value=String(preset.amps); ampsInp.style.width='7ch'; ampsInp.style.textAlign='right';
    const spacer=document.createElement('div');
    const delBtn=document.createElement('button'); delBtn.type='button'; delBtn.textContent='✕'; delBtn.title='Remove'; delBtn.style.minWidth='2rem';

    row.append(ampsLbl,ampsInp,spacer,delBtn);
    evPanel.querySelector('#ev-rows').appendChild(row);

    const recalcBound=recalc.bind(null);
    ampsInp.addEventListener('input', ()=>{ recalcBound(); refreshLmsListDisabled(); });
    delBtn.addEventListener('click', ()=>{ row.remove(); buildLmsList(); recalc(); });
  }

  // --------- Heating helper ----------
  function getHeatCandidateW(acEffective){
    const type=heatTypeEl ? heatTypeEl.value : 'none';
    const kw=parseFloat(heatKwEl && heatKwEl.value ? heatKwEl.value : '0') || 0;
    if (type==='resistance') return Math.round(kw*1000);
    if (type==='hp_supp')   return acEffective + Math.round(kw*1000*0.65);
    return 0;
  }

  function updateSummary(){
    const count=APPLIANCES.filter(a=>el('cb_'+a.id).checked).length;
    summaryCount.textContent=count;
  }

  function applyPreset(scope){
    APPLIANCES.forEach(a=>{ const cb=el('cb_'+a.id); if (cb) cb.checked=false; });
    APPLIANCES.filter(a=>a.defaultScopes.includes(scope)).forEach(a=>{ const cb=el('cb_'+a.id); if (cb) cb.checked=true; });
    if (scope==='essentials'){ ['spaceHeat','waterHeater','elecRange','elecDryer'].forEach(id=>{ const c=el('cb_'+id); if (c) c.checked=false; }); }
    if (scope==='most'){ ['waterHeater','elecDryer','elecRange'].forEach(id=>{ const c=el('cb_'+id); if (c) c.checked=false; }); }
    { const c=el('cb_hottub'); if (c) c.checked=false; }

    acRowsEl.innerHTML=''; setSection(acPanel,toggleAc,false);
    setSection(heatPanel,toggleHeat,false);
    const evRowsEl=el('ev-rows'); if (evRowsEl) evRowsEl.innerHTML='';
    setSection(evPanel,toggleEv,false);

    if (smallQtyEl) smallQtyEl.value='2';
    if (laundryQtyEl) laundryQtyEl.value='1';
    updateSummary(); setPanel(false); buildLmsList(); recalc();
  }

  // --------- Generator picker ----------
  function pickGenerator(neededAmps, surgeAmps, fuel){
    const key=fuel==='ng'?'amps_ng':'amps_lp';
    const contOK=GEN_TABLE.filter(r=>Number(r[key])>=neededAmps);
    if (!contOK.length) return { label:`≥ ${Math.ceil(neededAmps)} A continuous (custom)`, amps_lp:neededAmps, amps_ng:neededAmps, max_surge:surgeAmps };
    contOK.sort((a,b)=>Number(a[key])-Number(b[key]));
    const bothOK=contOK.find(r=>Number(r.max_surge)>=surgeAmps);
    return bothOK || contOK[0];
  }

  function computeAirFactor(elevFt, tempF){
    const altTerm = elevFt > 0 ? (elevFt / 1000) * 0.035 : 0; // 3.5% per 1000 ft above sea level
    const tempExcess = Math.max(0, (tempF || 0) - 60);
    const tempTerm = (tempExcess / 10) * 0.01;                // 1% per 10°F above 60
    return 1 + altTerm + tempTerm;
  }

  function computeLiquidFactor(elevFt, tempF){
    const altExcessFt = Math.max(0, elevFt - 600);
    const altTerm = (altExcessFt / 1000) * 0.03;              // 3% per 1000 ft above 600 ft
    const tempExcess = Math.max(0, (tempF || 0) - 77);
    const tempTerm = (tempExcess / 10) * 0.0165;              // 1.65% per 10°F above 77
    return 1 + altTerm + tempTerm;
  }

  // --------- Core calc ----------
  function recalc(){
    // Determine ZIP-based environment (elevation & temp)
    const zipRaw = (zipEl?.value || '').trim();
    let zipDigits = zipRaw.replace(/\D/g,'');
    let zipKey = '';
    if (zipDigits.length) {
      zipKey = zipDigits.padStart(5,'0').slice(-5);
    }

    let env = { elevFt:0, tempF:60, source:'default' };
    if (zipKey && ZIP_TABLE.size) {
      const row = ZIP_TABLE.get(zipKey);
      if (row) {
        env = { elevFt: row.elevFt, tempF: row.tempF, source:'zip' };
      } else {
        env.source = 'zip-missing';
      }
    } else if (zipKey && !ZIP_TABLE.size) {
      env.source = 'table-missing';
    }

    // NEC from sqft + branch circuits
    const sqft=parseInt(sqftEl?.value||'0',10)||0;
    const necLighting=Math.max(0, Math.round(sqft*3));
    const saQty=parseInt(smallQtyEl?.value||'0',10)||0;
    const laQty=parseInt(laundryQtyEl?.value||'0',10)||0;
    const branchW=(saQty+laQty)*1500;

    // Appliances: split unmanaged vs managed (largest)
    let nonLmsApplianceW=0; const managedGeneral=[];
    APPLIANCES.forEach(a=>{
      const cb=el('cb_'+a.id); if (!cb||!cb.checked) return;
      const runEl=el('run_'+a.id); const v=parseInt(runEl?.value,10);
      const run=Number.isFinite(v)?v:a.run;
      const lms=el('lms_'+a.id);
      const isManaged=(lmsEnableEl && lmsEnableEl.value==='yes') && lms && lms.checked;
      if (isManaged) managedGeneral.push(run); else nonLmsApplianceW+=run;
    });
    const largestManagedGeneral = managedGeneral.length ? Math.max(...managedGeneral) : 0;

    // A/C rows: sum unmanaged + largest managed
    let acUnmanaged=0; const acManaged=[];
    const acRows=Array.from(acRowsEl.querySelectorAll('.ac-row'));
    acRows.forEach((row,i)=>{
      const input=row.querySelector('.ac-subgrid input[type="number"]');
      const runA=input ? parseFloat(input.value||'0')||0 : 0;
      const runW=Math.round(runA*240);
      const lms=el(`lms_ac_${i}`);
      const isManaged=(lmsEnableEl && lmsEnableEl.value==='yes') && lms && lms.checked;
      if (isManaged) acManaged.push(runW); else acUnmanaged+=runW;
    });
    const acManagedMax = acManaged.length ? Math.max(...acManaged) : 0;
    const acEffective  = acUnmanaged + acManagedMax;

    // Heating candidate (uses AC effective if HP supplemental)
    const heatCandidate = getHeatCandidateW(acEffective);

    // Seasonal effective (one big thing at a time)
    const seasonalEffective = Math.max(acEffective, heatCandidate);

    // EV: sum unmanaged + largest managed
    let evUnmanaged=0; const evManaged=[];
    const evRows=Array.from((evPanel?.querySelector('#ev-rows')||document.createElement('div')).querySelectorAll('.ev-row'));
    evRows.forEach((row,i)=>{
      const input=row.querySelector('input[type="number"]');
      const amps=input ? parseFloat(input.value||'0')||0 : 0;
      const runW=Math.round(amps*240);
      const lms=el(`lms_ev_${i}`);
      const isManaged=(lmsEnableEl && lmsEnableEl.value==='yes') && lms && lms.checked;
      if (isManaged) evManaged.push(runW); else evUnmanaged+=runW;
    });
    const evManagedMax = evManaged.length ? Math.max(...evManaged) : 0;
    const evEffective  = evUnmanaged + evManagedMax;

    // Demand factor (NEC) for general non-AC
    const totalGeneral = necLighting + branchW + nonLmsApplianceW + largestManagedGeneral;
    const first10k=Math.min(totalGeneral,10000), remainder=Math.max(totalGeneral-10000,0);
    const weightedGeneral=first10k + Math.round(remainder*0.40);

    // Running watts (continuous)
    const runningWatts = weightedGeneral + seasonalEffective + evEffective;

    // Continuous amps BEFORE buffer, BEFORE derating
    const buffer=Math.max(0, Math.min(50, parseInt(bufferPctEl?.value||'20',10) || 20));
    const bufferFrac = buffer / 100;
    const baseRunningAmps = runningWatts / 240;

    // Surge amps via max-start swap (baseline, before derating)
    const msStartA=parseFloat(msStartAmpsEl?.value||'0')||0;
    const msRunA  =parseFloat(msRunAmpsEl?.value||'0')||0;
    const soft    =(msSoftEl?.value||'no')==='yes' ? 0.5 : 1.0;
    const preBufferAmps=baseRunningAmps;
    const surgeDeltaA=Math.max(0, (msStartA*soft) - msRunA);
    const baseSurgeAmps=preBufferAmps + surgeDeltaA;

    const fuel=(fuelEl?.value||'lp');

    // Helper: pick generator given assumed cooling type for derating
    function pickWithEnv(coolingHint){
      const elevFt = env.elevFt || 0;
      const tempF = env.tempF || 60;
      const factor = coolingHint === 'liquid'
        ? computeLiquidFactor(elevFt, tempF)
        : computeAirFactor(elevFt, tempF);

      // Apply derating as a multiplier on required amps BEFORE buffer
      const deratedRunAmps = baseRunningAmps * factor;
      const deratedSurgeAmps = baseSurgeAmps * factor; // conservative: apply same factor to surge

      const neededAmps = deratedRunAmps / (1 - bufferFrac);
      const choice = pickGenerator(neededAmps, deratedSurgeAmps, fuel);

      return { factor, neededAmps, surgeAmps: deratedSurgeAmps, choice };
    }

    // First assume air-cooled (most common), then adjust if final choice is liquid-cooled
    let interim = pickWithEnv('air');
    let coolingType = (interim.choice && typeof interim.choice.cooling === 'string' && interim.choice.cooling.toLowerCase().startsWith('liquid'))
      ? 'liquid'
      : 'air';

    if (coolingType === 'liquid') {
      interim = pickWithEnv('liquid');
    }

    const neededAmps = interim.neededAmps;
    const surgeAmps = interim.surgeAmps;
    const choice = interim.choice;

    // Cooling note + LC advisory (hide if LMS is enabled)
    const isPortable = neededAmps <= 30;
    let coolingNote = '';
    if (!isPortable && choice && typeof choice.cooling === 'string' && choice.cooling.trim()){
      const c = choice.cooling.trim().toLowerCase();
      coolingNote = c.startsWith('liquid') ? ' — Liquid-cooled' : ' — Air-cooled';
    }
    const lcAlertEl = document.getElementById('lc-alert');
    const isLiquid  = (!isPortable && (
      (choice && typeof choice.cooling === 'string' && choice.cooling.toLowerCase().startsWith('liquid')) ||
      String(coolingNote).toLowerCase().includes('liquid-cooled')
    ));
    const lmsOn = (lmsEnableEl && lmsEnableEl.value === 'yes');
    if (lcAlertEl) lcAlertEl.style.display = (!lmsOn && isLiquid) ? 'block' : 'none';

    // Output
    runWEl.textContent = runningWatts.toLocaleString();
    needAEl.textContent = Math.ceil(neededAmps).toString();
    peakAEl.textContent = Math.ceil(surgeAmps).toString();
    recEl.textContent = `${choice.label} (${fuel==='lp'?'LP':'NG'})${coolingNote}`;

        // LMS summary tiles
    lmsMaxGeneralEl.textContent = `${largestManagedGeneral.toLocaleString()} W`;
    lmsMaxOthersEl.textContent  = `${Math.max(acManagedMax, evManagedMax).toLocaleString()} W`;

    // Maintain panel heights when open
    if (panel?.getAttribute('data-open')==='1') panel.style.maxHeight=panel.scrollHeight+'px';
    if (acPanel?.getAttribute('data-open')==='1') acPanel.style.maxHeight=acPanel.scrollHeight+'px';
    if (heatPanel?.getAttribute('data-open')==='1') heatPanel.style.maxHeight=heatPanel.scrollHeight+'px';
    if (lmsSectionEl?.getAttribute('data-open')==='1') lmsSectionEl.style.maxHeight=lmsSectionEl.scrollHeight+'px';


    // Maintain panel heights when open
    if (panel?.getAttribute('data-open')==='1') panel.style.maxHeight=panel.scrollHeight+'px';
    if (acPanel?.getAttribute('data-open')==='1') acPanel.style.maxHeight=acPanel.scrollHeight+'px';
    if (heatPanel?.getAttribute('data-open')==='1') heatPanel.style.maxHeight=heatPanel.scrollHeight+'px';
    if (lmsSectionEl?.getAttribute('data-open')==='1') lmsSectionEl.style.maxHeight=lmsSectionEl.scrollHeight+'px';
  }

  // --------- Wire-up ----------
  function updateSummaryAndCalc(){ updateSummary(); refreshLmsListDisabled(); recalc(); }

  scopeEl.addEventListener('change', e=>applyPreset(e.target.value));
  listEl.addEventListener('change', updateSummaryAndCalc);
  listEl.addEventListener('input',  updateSummaryAndCalc);
  sqftEl?.addEventListener('input', recalc);
  smallQtyEl?.addEventListener('input', recalc);
  laundryQtyEl?.addEventListener('input', recalc);
  addAcBtn.addEventListener('click', ()=>{ addAcRow(); setSection(acPanel,toggleAc,true); buildLmsList(); recalc(); });
  addEvBtn?.addEventListener('click', ()=>{ addEvRow(); setSection(evPanel,toggleEv,true); buildLmsList(); recalc(); });
  bufferPctEl?.addEventListener('input', recalc);
  fuelEl?.addEventListener('change', recalc);
  heatTypeEl?.addEventListener('change', ()=>{ buildLmsList(); recalc(); });
  heatKwEl?.addEventListener('input',  ()=>{ buildLmsList(); recalc(); });

  // Max-start listeners
  msStartAmpsEl?.addEventListener('input', recalc);
  msRunAmpsEl?.addEventListener('input', recalc);
  msVoltsEl?.addEventListener('change', recalc);
  msSoftEl?.addEventListener('change', recalc);

  // ZIP listener
  zipEl?.addEventListener('input', recalc);

  // LMS enable/disable
  lmsEnableEl?.addEventListener('change', ()=>{
    const on=lmsEnableEl.value==='yes';
    lmsSectionEl.setAttribute('data-open', on?'1':'0');
    lmsSectionEl.style.maxHeight = on ? (lmsSectionEl.scrollHeight + 'px') : '0';
    lmsToggleEl.textContent = on ? 'Hide details ▴' : 'Show details ▾';
    refreshLmsListDisabled(); recalc();
  });

  // --------- Init ----------
  (async()=>{
    await Promise.all([tryLoadCsv(), tryLoadZipCsv()]);
    buildLmsList();
    applyGrid();
    applyPreset('essentials');
  })();
});
</script>
