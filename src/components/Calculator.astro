---
export const prerender = true;
const pageTitle = "Generator Sizing Calculator";
---

<head>
  <title>{pageTitle}</title>
</head>

<style is:global>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 0;
    color: #1f2937;
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 1.25rem 1.25rem 2rem;
  }
  
  .header {
    text-align: center;
    color: white;
    margin-bottom: 1.5rem;
    animation: fadeIn 0.6s ease-out;
  }
  
  .header h1 {
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    font-weight: 700;
    margin-bottom: 0.5rem;
    letter-spacing: -0.02em;
  }
  
  .header p {
    font-size: clamp(0.95rem, 2vw, 1.1rem);
    opacity: 0.95;
  }

  .header-subline {
    margin-top: 0.35rem;
    font-size: 0.9rem;
    opacity: 0.85;
  }
  
  /* Main Calculator Layout */
  .calc-grid {
    display: grid;
    gap: 1.25rem;
    animation: slideUp 0.6s ease-out 0.1s both;
  }

  @media (min-width: 900px) {
    .calc-grid {
      grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
      align-items: flex-start;
    }
  }
  
  .calc-card {
    background: white;
    border-radius: 16px;
    padding: clamp(1.25rem, 3vw, 2rem);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 10px 25px rgba(0, 0, 0, 0.08);
  }

  .inputs {
    width: 100%;
  }

  /* Dark, premium summary card */
  .summary-card {
    position: sticky;
    top: 1rem;
    align-self: flex-start;
    background: #020617;
    color: #f9fafb;
    border-radius: 16px;
    box-shadow: 0 18px 40px rgba(15, 23, 42, 0.6);
    padding: 1.5rem 1.5rem 1.25rem;
  }

  .summary-card p {
    margin: 0.25rem 0;
  }

  @media (max-width: 899px) {
    .summary-card {
      order: 1;
      position: relative;
      top: 0;
      margin-bottom: 1.5rem;
    }

    .inputs {
      order: 2;
    }
  }
  
  .section {
    margin-bottom: 2rem;
  }
  
  .section:last-child {
    margin-bottom: 0;
  }
  
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #f3f4f6;
  }
  
  .section-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: #111827;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .section-step {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #9ca3af;
    font-weight: 600;
  }
  
  .section-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }
  
  label {
    display: block;
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
  }

  .label-row {
    display: flex;
    align-items: center;
    gap: 0.35rem;
  }
  
  input, select {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    font-size: 1rem;
    background: white;
    transition: all 0.2s;
    font-family: inherit;
    min-height: 44px; /* touch target */
  }
  
  input:focus, select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.25);
  }
  
  input:hover, select:hover {
    border-color: #cbd5e1;
  }
  
  .input-hint {
    display: block;
    font-size: 0.85rem;
    color: #6b7280;
    margin-top: 0.35rem;
    line-height: 1.4;
  }
  
  .form-group {
    margin-bottom: 1.25rem;
  }
  
  .form-row {
    display: grid;
    gap: 1rem;
    grid-template-columns: 1fr;
  }
  
  @media (min-width: 640px) {
    .form-row {
      grid-template-columns: 1fr 1fr;
    }
  }
  
  /* Buttons */
  button {
    font-family: inherit;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
  }
  
  .btn-primary {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 0.65rem 1.25rem;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
  }
  
  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }
  
  .btn-primary:active {
    transform: translateY(0);
  }
  
  .btn-secondary {
    background: white;
    color: #667eea;
    padding: 0.5rem 1rem;
    border: 2px solid #667eea;
    border-radius: 8px;
  }
  
  .btn-secondary:hover {
    background: #f0f4ff;
  }
  
  .btn-text {
    background: transparent;
    color: #667eea;
    padding: 0.5rem;
    font-weight: 600;
  }
  
  .btn-text:hover {
    color: #5568d3;
    text-decoration: underline;
  }
  
  .btn-remove {
    background: #fee;
    color: #dc2626;
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    min-width: 2.5rem;
  }
  
  .btn-remove:hover {
    background: #fcc;
  }

  .help-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1.15rem;
    height: 1.15rem;
    border-radius: 50%;
    border: 1px solid #9ca3af;
    font-size: 0.75rem;
    color: #4b5563;
    cursor: help;
    background: #f9fafb;
  }
  
  /* Collapsible Sections */
  .collapsible-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: #f9fafb;
    border-radius: 10px;
    cursor: pointer;
    transition: background 0.2s;
    margin-bottom: 0.5rem;
  }
  
  .collapsible-header:hover {
    background: #f3f4f6;
  }
  
  .collapsible-content {
    overflow: hidden;
    max-height: 0;
    transition: max-height 0.3s ease;
  }
  
  .collapsible-content.open {
    max-height: 5000px;
  }
  
  .toggle-icon {
    transition: transform 0.3s;
    font-weight: 700;
    color: #667eea;
  }
  
  .toggle-icon.open {
    transform: rotate(180deg);
  }
  
  /* Appliance List (driven by JS, uses .appliance-row) */
  .appliance-grid {
    display: grid;
    gap: 0.75rem;
    margin-top: 1rem;
  }
  
  @media (min-width: 640px) {
    .appliance-grid {
      grid-template-columns: 1fr 1fr;
    }
  }
  
  .appliance-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: #f9fafb;
    border-radius: 10px;
    border: 2px solid transparent;
    transition: all 0.2s;
  }
  
  .appliance-row input[type="checkbox"] {
    width: 1.25rem;
    height: 1.25rem;
    cursor: pointer;
    flex-shrink: 0;
  }
  
  .appliance-row input[type="number"],
  .watt-input {
    width: 7ch;
    padding: 0.4rem 0.5rem;
    text-align: right;
    font-size: 0.9rem;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    min-height: 34px;
  }
  
  .appliance-row .name {
    flex: 1;
    font-size: 0.95rem;
    color: #374151;
  }
  
  .appliance-row:hover {
    border-color: #667eea;
    background: #eff6ff;
  }
  
  /* AC/EV Rows */
  .dynamic-row {
    display: grid;
    gap: 0.75rem;
    padding: 1rem;
    background: #f9fafb;
    border-radius: 10px;
    border: 2px solid #e5e7eb;
    margin-bottom: 0.75rem;
  }
  
  @media (min-width: 640px) {
    .dynamic-row {
      grid-template-columns: 1fr 1fr auto;
      align-items: end;
    }
  }
  
  .ac-subgrid input[type="number"] {
    width: 7ch;
    text-align: right;
  }
  
  /* Summary Card content */
  .summary-title {
    font-size: 1.1rem;
    font-weight: 600;
    opacity: 0.9;
    margin-bottom: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .summary-result {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    line-height: 1.2;
    color: #fbbf24;
  }

  .summary-copy {
    font-size: 0.85rem;
    line-height: 1.4;
    opacity: 0.9;
    margin-bottom: 1.25rem;
  }
  
  .summary-details {
    display: grid;
    gap: 1rem;
  }
  
  .detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
  }
  
  .detail-label {
    font-size: 0.9rem;
    opacity: 0.85;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }
  
  .detail-value {
    font-weight: 700;
    font-size: 1.1rem;
  }
  
  .alert {
    padding: 1rem;
    border-radius: 10px;
    margin-top: 1rem;
    font-size: 0.9rem;
    line-height: 1.5;
  }
  
  .alert-warning {
    background: #fef3c7;
    color: #92400e;
    border-left: 4px solid #f59e0b;
  }
  
  .alert-info {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.9);
    border-left: 4px solid rgba(255, 255, 255, 0.3);
  }
  
  .divider {
    height: 2px;
    background: linear-gradient(90deg, transparent, #e5e7eb, transparent);
    margin: 2rem 0;
  }
  
  .disclaimer {
    text-align: center;
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.9rem;
    margin-top: 2rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
  }

  /* Bottom stepper nav */
  .flow-steps {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin: 2rem 0 1rem;
  }

  .flow-steps button {
    width: 2.25rem;
    height: 2.25rem;
    border-radius: 999px;
    border: none;
    font-weight: 600;
    font-size: 0.9rem;
    background: #e5e7eb;
    color: #111827;
    cursor: pointer;
    transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
  }

  .flow-steps button:hover {
    background: #c7d2fe;
    box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
    transform: translateY(-1px);
  }
  
  /* How to Use Section */
  .how-to-use {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    margin-top: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 10px 25px rgba(0, 0, 0, 0.08);
    animation: slideUp 0.6s ease-out 0.2s both;
  }
  
  .how-to-use h2 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
    color: #111827;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .how-to-use h2::before {
    content: "üí°";
    font-size: 1.75rem;
  }
  
  .steps {
    display: grid;
    gap: 1rem;
    margin-top: 1rem;
  }
  
  .step {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    background: #f9fafb;
    border-radius: 12px;
    border-left: 4px solid #667eea;
    transition: background 0.15s ease;
    animation: slideUp 0.45s ease-out both;
  }

  .step:nth-child(1) { animation-delay: 0.05s; }
  .step:nth-child(2) { animation-delay: 0.10s; }
  .step:nth-child(3) { animation-delay: 0.15s; }
  .step:nth-child(4) { animation-delay: 0.20s; }
  .step:nth-child(5) { animation-delay: 0.25s; }
  
  .step:hover {
    background: #f3f4f6;
  }
  
  .step-number {
    flex-shrink: 0;
    width: 1.5rem;
    height: 1.5rem;
    background: #e5e7eb;
    color: #4b5563;
    border-radius: 999px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.8rem;
    border: none;
    cursor: default;
  }
  
  .step-content h3 {
    font-size: 1rem;
    margin-bottom: 0.25rem;
    color: #111827;
  }
  
  .step-content p {
    font-size: 0.9rem;
    color: #6b7280;
    line-height: 1.5;
  }
  
  .appliance-tag-guide {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border-radius: 12px;
    padding: 1.25rem;
    margin-top: 1rem;
    border: 2px dashed #f59e0b;
  }
  
  .appliance-tag-guide h3 {
    font-size: 1.1rem;
    color: #92400e;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .appliance-tag-guide h3::before {
    content: "üìã";
  }
  
  .tag-tips {
    display: grid;
    gap: 0.5rem;
    font-size: 0.9rem;
    color: #78350f;
  }
  
  .tag-tip {
    display: flex;
    align-items: start;
    gap: 0.5rem;
  }
  
  .tag-tip::before {
    content: "‚Üí";
    color: #f59e0b;
    font-weight: 700;
    flex-shrink: 0;
  }

  /* Mini cards for LMS */
  .mini-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 0.75rem;
    margin-top: 1rem;
  }
  
  .mini-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    padding: 0.75rem;
    text-align: center;
  }
  
  .mini-label {
    font-size: 0.75rem;
    color: #6b7280;
    margin-bottom: 0.25rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .mini-value,
  .mini-val {
    font-size: 1.25rem;
    font-weight: 700;
    color: #111827;
  }
  
  /* NEC Circuits */
  .nec-grid {
    display: grid;
    gap: 1rem;
    margin: 1rem 0;
  }
  
  @media (min-width: 640px) {
    .nec-grid {
      grid-template-columns: 2fr 1fr;
    }
  }
  
  .nec-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: #f9fafb;
    border-radius: 10px;
  }
  
  .nec-item label {
    margin: 0;
    flex: 1;
  }
  
  .nec-item input {
    width: 7ch;
    text-align: right;
  }

  .section-highlight {
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.4);
    border-radius: 16px;
    transition: box-shadow 0.4s ease-out;
  }
  
  /* Responsive adjustments */
  @media (max-width: 640px) {
    .calc-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
      animation-duration: 0.001ms !important;
      animation-iteration-count: 1 !important;
      transition: none !important;
    }
  }
  
  /* Animations */
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>


  
  <div class="calc-grid">
    <!-- Main Calculator (left) -->
    <div class="inputs calc-card">
      <!-- Step 1: Coverage + home details -->
      <section id="step-1-coverage">
        <!-- Coverage -->
        <div class="section" id="scope-section">
          <div class="section-header">
            <div class="section-title">What do you want to power?</div>
            <div class="section-step">Step 1 of 5</div>
          </div>
          <div class="form-group">
            <label for="scope">Coverage level</label>
            <select id="scope">
              <option value="essentials">Essentials (fridge, lights, furnace blower)</option>
              <option value="most">Most of house (kitchen + some HVAC)</option>
              <option value="whole">Whole house (unrestricted typical use)</option>
            </select>
          </div>
        </div>

        <!-- Home details -->
        <div class="section" id="home-details-section">
          <div class="section-header">
            <div class="section-title">Home details</div>
            <div class="section-step">Step 2 of 5</div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="zip">Home ZIP code (US, 5 digits)</label>
              <input id="zip" type="text" inputmode="numeric" maxlength="5" placeholder="e.g., 19087" />
              <span class="input-hint">
                Used to estimate elevation &amp; typical summer high. Leave blank to assume sea level &amp; 60&nbsp;¬∞F.
              </span>
            </div>
            
            <div class="form-group">
              <label for="sqft">Home square footage</label>
              <input id="sqft" type="number" min="0" step="50" placeholder="e.g., 2400" />
              <span class="input-hint">
                NEC general lighting load = 3 watts per sq ft √ó this number. Include garage &amp; basement.
              </span>
            </div>
          </div>
        </div>
      </section>
      
      <div class="divider"></div>
      
      <!-- Step 2: Appliances -->
      <section id="step-2-appliances">
        <div class="section" id="appliance-section">
          <div id="appliance-header" class="section-header">
            <div>
              <div class="section-title">Appliances &amp; circuits</div>
              <small style="color: #6b7280; margin-top: 0.25rem; display: block;">
                ‚úÖ Preset applied.
                <span id="appliance-summary">
                  <span id="summary-count">0</span> items selected.
                </span>
              </small>
            </div>
            <div class="section-step">Step 3 of 5</div>
          </div>

          <div id="appliance-panel" class="collapsible-content" data-open="0">
            <div class="nec-grid">
              <div class="nec-item">
                <label>
                  Small-appliance circuits
                  <small style="color: #6b7280;">(1500W each)</small>
                </label>
                <input id="smallQty" type="number" min="0" step="1" value="2" />
              </div>
              <div class="nec-item">
                <label>
                  Laundry circuits
                  <small style="color: #6b7280;">(1500W each)</small>
                </label>
                <input id="laundryQty" type="number" min="0" step="1" value="1" />
              </div>
            </div>
            
            <div class="appliance-grid" id="appliance-list"></div>
          </div>

          <div style="margin-top: 0.5rem;">
            <button
              id="toggle-appliances"
              type="button"
              class="btn-text"
              aria-controls="appliance-panel"
              aria-expanded="false"
            >
              Show appliance details ‚ñæ
            </button>
          </div>
        </div>
      </section>
      
      <div class="divider"></div>
      
      <!-- Step 3: HVAC (AC + Heating + EV) -->
      <section id="step-3-hvac">
        <div class="section" id="hvac-section">
          <div class="section-header">
            <div class="section-title">HVAC &amp; EV loads</div>
            <div class="section-step">Step 4 of 5</div>
          </div>

          <!-- Air Conditioning -->
          <div class="section" id="ac-section">
            <div class="section-header" style="border-bottom: none; padding-bottom: 0.5rem; margin-bottom: 0.5rem;">
              <div class="section-title" style="font-size: 1rem;">‚ùÑÔ∏è Air conditioning</div>
              <div class="section-actions">
                <button
                  class="btn-secondary"
                  id="toggle-ac"
                  type="button"
                  aria-controls="ac-panel"
                  aria-expanded="false"
                >
                  Show details ‚ñæ
                </button>
                <button class="btn-primary" id="add-ac" type="button">+ Add AC system</button>
              </div>
            </div>
            <span class="input-hint">Add one row per outdoor condenser (e.g., 3-ton up, 2-ton down).</span>
            <div class="collapsible-content" id="ac-panel" data-open="0" style="margin-top: 0.5rem;">
              <div id="ac-rows"></div>
            </div>
          </div>
          
          <div class="divider"></div>
          
          <!-- Heating -->
          <div class="section" id="heat-section">
            <div class="collapsible-header">
              <div class="section-title" style="font-size: 1rem;">üî• Heating</div>
              <button
                id="toggle-heat"
                type="button"
                class="btn-text"
                aria-controls="heat-panel"
                aria-expanded="false"
              >
                Show details ‚ñæ
              </button>
            </div>
            
            <div class="collapsible-content" id="heat-panel" data-open="0">
              <div class="form-row">
                <div class="form-group">
                  <label for="heat-type">Type</label>
                  <select id="heat-type">
                    <option value="none">None</option>
                    <option value="resistance">Electric resistance (furnace/baseboards)</option>
                    <option value="hp_supp">Heat pump + electric supplemental</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="heat-kw">kW (if applicable)</label>
                  <input id="heat-kw" type="number" min="0" step="0.5" placeholder="e.g., 10" />
                </div>
              </div>
              <span class="input-hint">
                Per NEC, we use the larger of heating or A/C. For heat pumps, we add 65% of supplemental heat.
              </span>
            </div>
          </div>
          
          <div class="divider"></div>
          
          <!-- EV Chargers (part of HVAC/EV step) -->
          <div class="section" id="ev-section">
            <div class="section-header" style="border-bottom: none, padding-bottom: 0.5rem; margin-bottom: 0.5rem;">
              <div class="section-title" style="font-size: 1rem;">üîå EV chargers</div>
              <div class="section-actions">
                <button
                  class="btn-secondary"
                  id="toggle-ev"
                  type="button"
                  aria-controls="ev-panel"
                  aria-expanded="false"
                >
                  Show details ‚ñæ
                </button>
                <button class="btn-primary" id="add-ev" type="button">+ Add charger</button>
              </div>
            </div>
            <span class="input-hint">
              Included at 100% like A/C. Enter charging/breaker amps at 240 V.
            </span>
            <div class="collapsible-content" id="ev-panel" data-open="0" style="margin-top: 0.5rem;">
              <div id="ev-rows"></div>
            </div>
          </div>
        </div>
      </section>
      
      <div class="divider"></div>
      
      <!-- Step 4: Max start + LMS -->
      <section id="step-4-ev">
        <!-- Max Start -->
        <div class="section" id="maxstart-section">
          <div class="section-header">
            <div class="section-title">‚ö° Max starting load</div>
          </div>
          <span class="input-hint" style="display: block; margin-bottom: 1rem;">
            Enter details for the appliance with the highest starting surge (often an A/C or well pump). Use the largest
            starting amps (LRA) you see on any appliance tag. The yellow guide below shows where to find it.
          </span>
          <div class="form-row">
            <div class="form-group">
              <label for="ms-start-amps">Starting amps</label>
              <input id="ms-start-amps" type="number" min="0" step="0.1" placeholder="e.g., 40" />
            </div>
            <div class="form-group">
              <label for="ms-run-amps">Running amps</label>
              <input id="ms-run-amps" type="number" min="0" step="0.1" placeholder="e.g., 8" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="ms-volts">Voltage</label>
              <select id="ms-volts">
                <option value="120" selected>120V</option>
                <option value="240">240V</option>
              </select>
            </div>
            <div class="form-group">
              <label for="ms-soft">Soft starter?</label>
              <select id="ms-soft">
                <option value="no" selected>No</option>
                <option value="yes">Yes</option>
              </select>
            </div>
          </div>
          <span class="input-hint">
            Used to adjust peak (surge) amps for the recommendation. Soft starters typically cut start amps ~50%.
          </span>
        </div>
        
        <div class="divider"></div>
        
        <!-- LMS -->
        <div class="section" id="lms-section-wrapper">
          <div class="form-group">
            <label for="lms-enable">Load management system (LMS)</label>
            <select id="lms-enable">
              <option value="no" selected>No</option>
              <option value="yes">Yes</option>
            </select>
            <span class="input-hint">
              If enabled, we count the sum of unmanaged + the <em>largest</em> managed item for each category (general, HVAC, EV).
            </span>
          </div>
          
          <div
            id="lms-section"
            data-open="0"
            class="collapsible-content"
            style="margin-top: 0.75rem; border: 1px solid #e6ebf2; border-radius: 10px;"
          >
            <div style="padding: 0.75rem; display: flex; justify-content: space-between; align-items: center; gap: 0.5rem;">
              <div class="lbl" style="margin: 0;">
                LMS items ‚Äî <span id="lms-summary">No LMS items selected</span>
              </div>
              <button
                id="toggle-lms"
                type="button"
                class="btn-text"
                aria-controls="lms-panel"
                aria-expanded="false"
              >
                Show details ‚ñæ
              </button>
            </div>
            <div id="lms-panel" style="padding: 0.5rem 0.75rem 0.75rem;">
              <small class="input-hint">
                Select items to manage (shed/sequence). Only the <em>largest</em> managed item per category is counted
                along with unmanaged loads.
              </small>
              <div id="lms-list" class="appliance-grid" style="margin-top: 0.5rem;"></div>
              <div class="mini-cards" style="margin-top: 0.5rem;">
                <div class="mini-card">
                  <div class="mini-label">Managed count</div>
                  <div class="mini-val" id="lms-count">0</div>
                </div>
                <div class="mini-card">
                  <div class="mini-label">Largest managed (Appl.)</div>
                  <div class="mini-val" id="lms-max-general">0 W</div>
                </div>
                <div class="mini-card">
                  <div class="mini-label">Largest managed (AC/EV)</div>
                  <div class="mini-val" id="lms-max-others">0 W</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      
      <div class="divider"></div>
      
      <!-- Step 5: Settings -->
      <section id="step-5-settings">
        <div class="section" id="settings-section">
          <div class="section-header">
            <div class="section-title">Settings &amp; safety margin</div>
            <div class="section-step">Step 5 of 5</div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="fuelType">Fuel type</label>
              <select id="fuelType">
                <option value="lp" selected>LP (Propane)</option>
                <option value="ng">Natural gas</option>
              </select>
            </div>
            <div class="form-group">
              <div class="label-row">
                <label for="bufferPct">Headroom buffer (%)</label>
                <span
                  class="help-icon"
                  title="Extra safety margin above your expected running load. Most homes use 10‚Äì30%."
                >?</span>
              </div>
              <input id="bufferPct" type="number" min="0" max="50" step="1" value="20" />
              <span class="input-hint" id="bufferHint">
                Default is 20%. Most homes use 10‚Äì30% headroom.
              </span>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Summary Card (right on desktop) -->
    <aside class="summary-card" id="summary-card" aria-live="polite">
      <div class="summary-title">Recommended Size</div>
      <div class="summary-result" id="rec">‚Äî</div>
      <p class="summary-copy">
        Sized with NEC-style diversity and headroom for motor starting.
        Always have a licensed electrician verify before purchase.
      </p>
      
      <div id="lc-alert" class="alert alert-warning" style="display: none;">
        üí° Consider a load management system to reduce required generator size.
      </div>
      
      <div class="summary-details">
        <div class="detail-row">
          <span class="detail-label">
            Planning load
            <span
              class="help-icon"
              title="Your estimated running load after NEC-style demand factors and managed loads."
            >?</span>
          </span>
          <span class="detail-value"><span id="runW">0</span> W</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">
            Needed amps (with buffer)
            <span
              class="help-icon"
              title="Continuous amps the generator must support, including your chosen headroom margin."
            >?</span>
          </span>
          <span class="detail-value"><span id="needA">0</span> A</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">
            Peak amps (with max-start)
            <span
              class="help-icon"
              title="Estimated surge amps when your largest motor/compressor starts."
            >?</span>
          </span>
          <span class="detail-value"><span id="peakA">0</span> A</span>
        </div>
      </div>
      
      <div class="alert alert-info" style="margin-top: 1.5rem;">
        Running amps = watts √∑ 240. Needed amps = running amps √∑ (1 ‚àí headroom%). Peak amps include the max-start swap
        (soft starter reduces start amps).
      </div>
      
      <small id="env-note" style="display: block; margin-top: 0.75rem; font-size: 0.8rem; opacity: 0.8;"></small>
    </aside>
  </div>

  <!-- Bottom stepper nav -->
  <nav class="flow-steps" aria-label="Calculator steps">
    <button type="button" data-step-target="#step-1-coverage">1</button>
    <button type="button" data-step-target="#step-2-appliances">2</button>
    <button type="button" data-step-target="#step-3-hvac">3</button>
    <button type="button" data-step-target="#step-4-ev">4</button>
    <button type="button" data-step-target="#step-5-settings">5</button>
  </nav>

  <!-- How to Use Section (below calculator) -->
  <div class="how-to-use">
    <h2>How to use this calculator</h2>
    <div class="steps">
      <div class="step">
        <div class="step-number">1</div>
        <div class="step-content">
          <h3>Choose your coverage level</h3>
          <p>Select whether you want to power essentials only, most of your house, or everything during an outage.</p>
        </div>
      </div>
      <div class="step">
        <div class="step-number">2</div>
        <div class="step-content">
          <h3>Enter your home details</h3>
          <p>Provide your ZIP code (for elevation/temperature adjustments) and square footage for accurate calculations.</p>
        </div>
      </div>
      <div class="step">
        <div class="step-number">3</div>
        <div class="step-content">
          <h3>Review &amp; adjust appliances</h3>
          <p>We'll pre-select common appliances based on your coverage level. You can customize the list and wattages as needed.</p>
        </div>
      </div>
      <div class="step">
        <div class="step-number">4</div>
        <div class="step-content">
          <h3>Add HVAC, heating &amp; EV chargers</h3>
          <p>Include any air conditioning units, heating systems, or electric vehicle chargers you want to power.</p>
        </div>
      </div>
      <div class="step">
        <div class="step-number">5</div>
        <div class="step-content">
          <h3>Get your recommendation</h3>
          <p>Use the summary card to see planning load, needed amps and peak surge, then talk to a licensed electrician.</p>
        </div>
      </div>
    </div>
    
    <div class="appliance-tag-guide">
      <h3>Finding appliance wattage &amp; starting amps</h3>
      <div class="tag-tips">
        <div class="tag-tip">Look for the metal nameplate or data tag on your appliance (usually on the back or bottom).</div>
        <div class="tag-tip">Find "Watts" or "W" ‚Äî this is the running wattage you'll enter here.</div>
        <div class="tag-tip">If only Amps and Volts are listed: Watts = Amps √ó Volts (e.g., 5A √ó 120V = 600W).</div>
        <div class="tag-tip">For motors/compressors, look for "LRA" or "Starting Amps" to use in the Max Starting Load section.</div>
        <div class="tag-tip">üì∏ <em>Video tutorial and photo examples coming soon!</em></div>
      </div>
    </div>
  </div>
  
  <div class="disclaimer">
    Heads up: This calculator is for general information only and does not replace a site visit or detailed load study.
    Always consult a licensed electrician and follow local codes before purchasing or installing a generator.
  </div>
</div>

<script>
window.addEventListener('DOMContentLoaded', () => {
  // --------- DATA ----------
  const APPLIANCES = [
    { id:'well',        name:'Well pump (3/4 hp)',              run:1500, defaultScopes:['most','whole'] },
    { id:'sump',        name:'Sump pump (1/2 hp)',              run:900,  defaultScopes:['essentials','most','whole'] },
    { id:'freezer',     name:'Chest freezer',                   run:120,  defaultScopes:['most','whole'] },
    { id:'microwave',   name:'Microwave (1.0‚Äì1.2 kW)',          run:1200, defaultScopes:['most','whole'] },
    { id:'disposal',    name:'Garbage disposal',                run:700,  defaultScopes:['most','whole'] },
    { id:'dishwasher',  name:'Dishwasher',                      run:1500, defaultScopes:['most','whole'] },
    { id:'elecRange',   name:'Electric range (cooktop+oven)',   run:8000, defaultScopes:['whole'] },
    { id:'wallOven',    name:'Wall-mounted oven (single)',      run:3000, defaultScopes:['whole'] },
    { id:'cooktop',     name:'Counter cooktop (electric)',      run:3500, defaultScopes:['whole'] },
    { id:'waterHeater', name:'Electric water heater (tank)',    run:4500, defaultScopes:['whole'] },
    { id:'elecDryer',   name:'Electric clothes dryer',          run:5500, defaultScopes:['whole'] },
    { id:'gdoor',       name:'Garage door opener',              run:500,  defaultScopes:['most','whole'] },
    { id:'septic',      name:'Septic grinder pump',             run:1000, defaultScopes:['most','whole'] },
    { id:'hottub',      name:'Hot tub / spa',                   run:10000,defaultScopes:['whole'] },
    { id:'pool',        name:'Pool pump (1‚Äì1.5 hp)',            run:1200, defaultScopes:[] },
    { id:'other',       name:'Other (enter watts)',             run:0,    defaultScopes:[] },
    { id:'fridge',      name:'Refrigerator',                    run:150,  defaultScopes:['essentials','most','whole'] },
    { id:'furnace',     name:'Furnace blower (gas/propane)',    run:600,  defaultScopes:['essentials','most','whole'] }
  ];
  const RUN_W_PER_TON = { standard:1100, inverter:750 };
  const AC_VOLTS = 240;

  // Fallback generator table (amps @ 240)
  let GEN_TABLE = [
    { label:'~10 kW standby', amps_lp:42, amps_ng:42, max_surge:55, cooling:'Air' },
    { label:'~14 kW standby', amps_lp:58, amps_ng:54, max_surge:75, cooling:'Air' },
    { label:'~18 kW standby', amps_lp:75, amps_ng:70, max_surge:90, cooling:'Air' },
    { label:'~22 kW standby', amps_lp:92, amps_ng:81, max_surge:110, cooling:'Air' },
    { label:'~24 kW standby', amps_lp:100, amps_ng:100, max_surge:120, cooling:'Air' },
    { label:'~26 kW standby', amps_lp:108, amps_ng:108, max_surge:130, cooling:'Air' }
  ];

  // ZIP -> { elevFt, tempF }
  const ZIP_TABLE = new Map();

  // --------- CSV loader (safe newline splitter) ----------
  async function tryLoadCsv() {
    const paths = ['/generator-amps.csv','/data/generator-amps.csv','/generator_amps.csv','/public/generator_amps.csv'];
    for (const p of paths) {
      try {
        const res = await fetch(p, { cache:'no-store' });
        if (!res.ok) continue;
        const text = await res.text();
        const rows = text.split('\n').map(l => (l.endsWith('\r') ? l.slice(0,-1) : l));
        if (!rows.length) continue;

        const header = rows.shift().split(',').map(s => s.trim().toLowerCase());
        const iLabel=header.indexOf('label'), iLP=header.indexOf('amps_lp'), iNG=header.indexOf('amps_ng'), iSurge=header.indexOf('max_surge'), iCooling=header.indexOf('cooling');
        if (iLabel<0||iLP<0||iNG<0||iSurge<0) continue;

        const parsed = rows.map(r=>{
          if (!r.trim()) return null;
          const c=r.split(',').map(s=>s.trim());
          return { label:c[iLabel], amps_lp:Number(c[iLP]), amps_ng:Number(c[iNG]), max_surge:Number(c[iSurge]), cooling:iCooling>=0?c[iCooling]:undefined };
        }).filter(x=>x && x.label && Number.isFinite(x.amps_lp) && Number.isFinite(x.amps_ng) && Number.isFinite(x.max_surge));

        if (parsed.length) GEN_TABLE = parsed.sort((a,b)=>Math.min(a.amps_lp,a.amps_ng)-Math.min(b.amps_lp,b.amps_ng));
        break;
      } catch { /* ignore */ }
    }
  }

  async function tryLoadZipCsv() {
    const paths = ['/zip_elevation_temp.csv','/data/zip_elevation_temp.csv','/public/zip_elevation_temp.csv'];
    for (const p of paths) {
      try {
        const res = await fetch(p, { cache:'no-store' });
        if (!res.ok) continue;
        const text = await res.text();
        const rows = text.split('\n').map(l => (l.endsWith('\r') ? l.slice(0,-1) : l));
        if (!rows.length) continue;

        const header = rows.shift().split(',').map(s => s.trim().toLowerCase());
        const iZip = header.indexOf('zip');
        const iElevM = header.indexOf('elevation_m');
        const iElevFt = iElevM < 0 ? header.indexOf('elevation_ft') : -1;
        const iElevGeneric = (iElevM < 0 && iElevFt < 0) ? header.indexOf('elevation') : -1;
        const iTemp = header.findIndex(h => h === 'temp' || h === 'temperature' || h === 'avg_temp' || h === 'avg_high');

        if (iZip < 0 || iTemp < 0 || (iElevM < 0 && iElevFt < 0 && iElevGeneric < 0)) continue;

        rows.forEach(r => {
          if (!r.trim()) return;
          const c = r.split(',').map(s => s.trim());
          const rawZip = c[iZip];
          if (!rawZip) return;
          let zipStr = String(rawZip).replace(/\D/g,'');
          if (!zipStr) return;
          zipStr = zipStr.padStart(5,'0').slice(-5);

          const elevRaw = c[iElevM >= 0 ? iElevM : (iElevFt >= 0 ? iElevFt : iElevGeneric)];
          const tempRaw = c[iTemp];
          const elevVal = parseFloat(elevRaw);
          const tempVal = parseFloat(tempRaw);
          if (!Number.isFinite(elevVal) || !Number.isFinite(tempVal)) return;

          const elevFt = iElevM >= 0 ? elevVal * 3.28084 : elevVal;

          ZIP_TABLE.set(zipStr, {
            elevFt,
            tempF: tempVal
          });
        });

        if (ZIP_TABLE.size) break;
      } catch { /* ignore */ }
    }
  }

  // --------- Elements ----------
  const el = id => document.getElementById(id);
  const scopeEl=el('scope'),
        listEl=el('appliance-list'),
        runWEl=el('runW'),
        needAEl=el('needA'),
        peakAEl=el('peakA');
  const sqftEl=el('sqft'),
        smallQtyEl=el('smallQty'),
        laundryQtyEl=el('laundryQty'),
        recEl=el('rec'),
        bufferPctEl=el('bufferPct'),
        fuelEl=el('fuelType');
  const acRowsEl=el('ac-rows'),
        addAcBtn=el('add-ac'),
        addEvBtn=el('add-ev');
  const heatTypeEl=el('heat-type'),
        heatKwEl=el('heat-kw');
  const acPanel=el('ac-panel'),
        heatPanel=el('heat-panel'),
        evPanel=el('ev-panel');
  const toggleAc=el('toggle-ac'),
        toggleHeat=el('toggle-heat'),
        toggleEv=el('toggle-ev');
  const panel=el('appliance-panel'),
        toggleBtn=el('toggle-appliances'),
        summaryCount=el('summary-count');

  const msStartAmpsEl=el('ms-start-amps'),
        msRunAmpsEl=el('ms-run-amps'),
        msVoltsEl=el('ms-volts'),
        msSoftEl=el('ms-soft');

  const zipEl = el('zip');
  const envNoteEl = el('env-note');

  // LMS refs
  const lmsEnableEl=el('lms-enable'),
        lmsSectionEl=el('lms-section'),
        lmsToggleEl=el('toggle-lms'),
        lmsPanelEl=el('lms-panel'),
        lmsListEl=el('lms-list');
  const lmsSummaryEl=el('lms-summary'),
        lmsCountEl=el('lms-count'),
        lmsMaxGeneralEl=el('lms-max-general'),
        lmsMaxOthersEl=el('lms-max-others');

  const bufferHintEl = el('bufferHint');

  // --------- Build Appliance rows ----------
  APPLIANCES.forEach(a=>{
    const wrap=document.createElement('label'); wrap.className='appliance-row';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.id='cb_'+a.id;
    const name=document.createElement('span'); name.className='name'; name.textContent=a.name;
    const unit=document.createElement('small'); unit.textContent=' (W run)';
    const run=document.createElement('input'); run.type='number'; run.id='run_'+a.id; run.className='watt-input'; run.min='0'; run.step='10'; run.value=a.run;
    wrap.append(cb,name,unit,run); listEl.appendChild(wrap);
    run.addEventListener('input', ()=>{ recalc(); refreshLmsListDisabled(); });
  });

  // --------- LMS list builders ----------
  function buildLmsList(){
    lmsListEl.innerHTML='';

    // Appliances (non-AC)
    APPLIANCES.forEach(a=>{
      const row=document.createElement('label'); row.className='appliance-row';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.id='lms_'+a.id;
      const nm=document.createElement('span'); nm.className='name'; nm.textContent=a.name;
      const mt=document.createElement('small'); mt.id='lmsmeta_'+a.id; mt.textContent=' (0 W run)';
      row.append(cb,nm,mt); lmsListEl.appendChild(row);
      cb.addEventListener('change', recalc);
    });

    // AC header + rows
    const acHeader=document.createElement('div'); acHeader.style.cssText='grid-column:1/-1;margin-top:.5rem;color:#555;font-weight:600'; acHeader.textContent='A/C units';
    lmsListEl.appendChild(acHeader);
    Array.from(acRowsEl.querySelectorAll('.ac-row')).forEach((row,i)=>{
      const r=document.createElement('label'); r.className='appliance-row';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.id=`lms_ac_${i}`;
      const nm=document.createElement('span'); nm.className='name'; nm.textContent=`Condenser ${i+1}`;
      const mt=document.createElement('small'); mt.id=`lmsmeta_ac_${i}`; mt.textContent=' (0 W run)';
      r.append(cb,nm,mt); lmsListEl.appendChild(r);
      cb.addEventListener('change', recalc);
    });

    // Heating
    const heatRow=document.createElement('label'); heatRow.className='appliance-row';
    const heatCb=document.createElement('input'); heatCb.type='checkbox'; heatCb.id='lms_heat';
    const heatNm=document.createElement('span'); heatNm.className='name'; heatNm.textContent='Heating';
    const heatMt=document.createElement('small'); heatMt.id='lmsmeta_heat'; heatMt.textContent=' (0 W run)';
    heatRow.append(heatCb,heatNm,heatMt); lmsListEl.appendChild(heatRow);
    heatCb.addEventListener('change', recalc);

    // EV header + rows
    const evHeader=document.createElement('div'); evHeader.style.cssText='grid-column:1/-1;margin-top:.5rem;color:#555;font-weight:600'; evHeader.textContent='EV chargers';
    lmsListEl.appendChild(evHeader);
    const evRows=Array.from((evPanel?.querySelector('#ev-rows')||document.createElement('div')).querySelectorAll('.ev-row'));
    evRows.forEach((row,i)=>{
      const r=document.createElement('label'); r.className='appliance-row';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.id=`lms_ev_${i}`;
      const nm=document.createElement('span'); nm.className='name'; nm.textContent=`EV charger ${i+1}`;
      const mt=document.createElement('small'); mt.id=`lmsmeta_ev_${i}`; mt.textContent=' (0 W run)';
      r.append(cb,nm,mt); lmsListEl.appendChild(r);
      cb.addEventListener('change', recalc);
    });

    refreshLmsListDisabled();
  }

  function refreshLmsListDisabled(){
    let managedCount=0;

    // Appliances
    APPLIANCES.forEach(a=>{
      const sel=el('cb_'+a.id), lms=el('lms_'+a.id), meta=el('lmsmeta_'+a.id), runEl=el('run_'+a.id);
      const on=!!(sel && sel.checked);
      const run=Math.max(0, parseInt(runEl?.value||'0',10) || 0);
      if (lms){
        lms.disabled = !on || (lmsEnableEl?.value!=='yes');
        if (!on) lms.checked=false;
        if (meta) meta.textContent=` (${run.toLocaleString()} W run)`;
        if (lms.checked) managedCount++;
      }
    });

    // AC rows
    Array.from(acRowsEl.querySelectorAll('.ac-row')).forEach((row,i)=>{
      const input=row.querySelector('.ac-subgrid input[type="number"]');
      const runA=input ? parseFloat(input.value||'0')||0 : 0;
      const runW=Math.round(runA*240);
      const lms=el(`lms_ac_${i}`), meta=el(`lmsmeta_ac_${i}`);
      if (lms){
        lms.disabled=(lmsEnableEl?.value!=='yes');
        if (meta) meta.textContent=` (${runW.toLocaleString()} W run)`;
        if (lms.checked) managedCount++;
      }
    });

    // Heating (meta = supplemental portion if HP)
    const heatCb=el('lms_heat'), heatMeta=el('lmsmeta_heat');
    if (heatCb){
      const type=heatTypeEl?.value||'none';
      const kw=parseFloat(heatKwEl?.value||'0')||0;
      let heatW=0;
      if (type==='resistance') heatW=Math.round(kw*1000);
      if (type==='hp_supp') heatW=Math.round(kw*1000*0.65);
      heatCb.disabled=(type==='none') || (lmsEnableEl?.value!=='yes');
      if (type==='none') heatCb.checked=false;
      if (heatMeta) heatMeta.textContent=` (${heatW.toLocaleString()} W run)`;
      if (heatCb.checked) managedCount++;
    }

    // EV rows
    const evRows=Array.from((evPanel?.querySelector('#ev-rows')||document.createElement('div')).querySelectorAll('.ev-row'));
    evRows.forEach((row,i)=>{
      const input=row.querySelector('input[type="number"]');
      const amps=input ? parseFloat(input.value||'0')||0 : 0;
      const runW=Math.round(amps*240);
      const lms=el(`lms_ev_${i}`), meta=el(`lmsmeta_ev_${i}`);
      if (lms){
        lms.disabled=(lmsEnableEl?.value!=='yes');
        if (meta) meta.textContent=` (${runW.toLocaleString()} W run)`;
        if (lms.checked) managedCount++;
      }
    });

    lmsSummaryEl.textContent = managedCount ? `${managedCount} item(s) selected` : 'No LMS items selected';
    lmsCountEl.textContent = String(managedCount);
    if (lmsSectionEl?.getAttribute('data-open')==='1') lmsSectionEl.style.maxHeight = lmsSectionEl.scrollHeight + 'px';
  }

  // --------- Responsive/grid helpers ----------
  const media=window.matchMedia('(max-width:520px)');
  function applyGrid(){
    listEl.style.gridTemplateColumns = media.matches ? '1fr' : '1fr 1fr';
    if (lmsListEl) lmsListEl.style.gridTemplateColumns = media.matches ? '1fr' : '1fr 1fr';
  }
  applyGrid();
  if (media.addEventListener) media.addEventListener('change', applyGrid); else if (media.addListener) media.addListener(applyGrid);

  // Collapsible helpers
  let open=false;
  function setPanel(on){
    open=on;
    panel.setAttribute('data-open',on?'1':'0');
    toggleBtn.setAttribute('aria-expanded',on?'true':'false');
    panel.style.maxHeight=on?panel.scrollHeight+'px':'0';
    toggleBtn.textContent=on?'Hide appliance details ‚ñ¥':'Show appliance details ‚ñæ';
  }
  function setSection(panelEl,toggleEl,on, labelBase){
    if(!panelEl||!toggleEl) return;
    panelEl.setAttribute('data-open',on?'1':'0');
    toggleEl.setAttribute('aria-expanded',on?'true':'false');
    panelEl.style.maxHeight=on?panelEl.scrollHeight+'px':'0';
    if (labelBase) {
      toggleEl.textContent = on ? `Hide ${labelBase} ‚ñ¥` : `Show ${labelBase} ‚ñæ`;
    }
  }
  toggleBtn.addEventListener('click', ()=>setPanel(!open));
  toggleAc?.addEventListener('click', ()=>setSection(acPanel,toggleAc,(acPanel?.getAttribute('data-open')!=='1'),'details'));
  toggleHeat?.addEventListener('click', ()=>setSection(heatPanel,toggleHeat,(heatPanel?.getAttribute('data-open')!=='1'),'details'));
  toggleEv?.addEventListener('click', ()=>setSection(evPanel,toggleEv,(evPanel?.getAttribute('data-open')!=='1'),'details'));
  lmsToggleEl?.addEventListener('click', ()=>setSection(lmsSectionEl,lmsToggleEl,(lmsSectionEl?.getAttribute('data-open')!=='1'),'details'));

  // --------- AC rows ----------
  function prefillRunAmps(tons,type){
    const runW=Math.max(0,tons)*(RUN_W_PER_TON[type]||RUN_W_PER_TON.standard);
    return Math.round((runW/AC_VOLTS)*10)/10;
  }
  function addAcRow(preset={tons:2.5,type:'standard'}){
    if (acRowsEl.children.length>=3) return;
    const row=document.createElement('div'); row.className='ac-row dynamic-row';
    row.style.gridTemplateColumns='1fr 1fr auto';

    const tonSel=document.createElement('select');
    [1.5,2,2.5,3,3.5,4,5].forEach(t=>{
      const o=document.createElement('option');
      o.value=t; o.textContent=`${t} ton`;
      tonSel.appendChild(o);
    });
    tonSel.value=preset.tons;

    const typeSel=document.createElement('select');
    [{v:'standard',n:'Standard (single-stage)'},{v:'inverter',n:'High-efficiency (inverter)'}].forEach(o=>{
      const op=document.createElement('option');
      op.value=o.v; op.textContent=o.n;
      typeSel.appendChild(op);
    });
    typeSel.value=preset.type;

    const delBtn=document.createElement('button'); delBtn.type='button'; delBtn.textContent='‚úï'; delBtn.title='Remove'; delBtn.className='btn-remove';

    const sub=document.createElement('div'); sub.className='ac-subgrid'; sub.style.gridColumn='1 / -1';
    const runLbl=document.createElement('label'); runLbl.textContent='Running amps';
    const runA=document.createElement('input'); runA.type='number'; runA.step='0.1'; runA.min='0';
    sub.append(runLbl,runA);

    row.append(tonSel, typeSel, delBtn, sub); acRowsEl.appendChild(row);

    function refreshDefault(){ runA.value=prefillRunAmps(parseFloat(tonSel.value)||0, typeSel.value); }
    refreshDefault();

    const recalcBound=recalc.bind(null);
    tonSel.addEventListener('change', ()=>{ refreshDefault(); recalcBound(); refreshLmsListDisabled(); });
    typeSel.addEventListener('change', ()=>{ refreshDefault(); recalcBound(); refreshLmsListDisabled(); });
    runA.addEventListener('input', ()=>{ recalcBound(); refreshLmsListDisabled(); });
    delBtn.addEventListener('click', ()=>{ row.remove(); buildLmsList(); recalc(); });
  }

  // --------- EV rows ----------
  function addEvRow(preset={amps:40}){
    const row=document.createElement('div'); row.className='ev-row dynamic-row';
    row.style.gridTemplateColumns='auto auto 1fr auto';

    const ampsLbl=document.createElement('label'); ampsLbl.textContent='Charger amps (240 V)';
    const ampsInp=document.createElement('input'); ampsInp.type='number'; ampsInp.step='1'; ampsInp.min='6'; ampsInp.value=String(preset.amps); ampsInp.style.width='7ch'; ampsInp.style.textAlign='right';
    const spacer=document.createElement('div');
    const delBtn=document.createElement('button'); delBtn.type='button'; delBtn.textContent='‚úï'; delBtn.title='Remove'; delBtn.className='btn-remove';

    row.append(ampsLbl,ampsInp,spacer,delBtn);
    evPanel.querySelector('#ev-rows').appendChild(row);

    const recalcBound=recalc.bind(null);
    ampsInp.addEventListener('input', ()=>{ recalcBound(); refreshLmsListDisabled(); });
    delBtn.addEventListener('click', ()=>{ row.remove(); buildLmsList(); recalc(); });
  }

  // --------- Heating helper ----------
  function getHeatCandidateW(acEffective){
    const type=heatTypeEl ? heatTypeEl.value : 'none';
    const kw=parseFloat(heatKwEl && heatKwEl.value ? heatKwEl.value : '0') || 0;
    if (type==='resistance') return Math.round(kw*1000);
    if (type==='hp_supp')   return acEffective + Math.round(kw*1000*0.65);
    return 0;
  }

  function updateSummary(){
    const count=APPLIANCES.filter(a=>el('cb_'+a.id).checked).length;
    summaryCount.textContent=count;
  }

  function applyPreset(scope){
    APPLIANCES.forEach(a=>{ const cb=el('cb_'+a.id); if (cb) cb.checked=false; });
    APPLIANCES.filter(a=>a.defaultScopes.includes(scope)).forEach(a=>{ const cb=el('cb_'+a.id); if (cb) cb.checked=true; });
    if (scope==='essentials'){ ['spaceHeat','waterHeater','elecRange','elecDryer'].forEach(id=>{ const c=el('cb_'+id); if (c) c.checked=false; }); }
    if (scope==='most'){ ['waterHeater','elecDryer','elecRange'].forEach(id=>{ const c=el('cb_'+id); if (c) c.checked=false; }); }
    { const c=el('cb_hottub'); if (c) c.checked=false; }

    acRowsEl.innerHTML=''; setSection(acPanel,toggleAc,false,'details');
    setSection(heatPanel,toggleHeat,false,'details');
    const evRowsEl=el('ev-rows'); if (evRowsEl) evRowsEl.innerHTML='';
    setSection(evPanel,toggleEv,false,'details');

    if (smallQtyEl) smallQtyEl.value='2';
    if (laundryQtyEl) laundryQtyEl.value='1';
    updateSummary(); setPanel(false); buildLmsList(); recalc();
  }

  // --------- Generator picker ----------
  function pickGenerator(neededAmps, surgeAmps, fuel){
    const key=fuel==='ng'?'amps_ng':'amps_lp';
    const contOK=GEN_TABLE.filter(r=>Number(r[key])>=neededAmps);
    if (!contOK.length) return { label:`‚â• ${Math.ceil(neededAmps)} A continuous (custom)`, amps_lp:neededAmps, amps_ng:neededAmps, max_surge:surgeAmps };
    contOK.sort((a,b)=>Number(a[key])-Number(b[key]));
    const bothOK=contOK.find(r=>Number(r.max_surge)>=surgeAmps);
    return bothOK || contOK[0];
  }

  function computeAirFactor(elevFt, tempF){
    const altTerm = elevFt > 0 ? (elevFt / 1000) * 0.035 : 0;
    const tempExcess = Math.max(0, (tempF || 0) - 60);
    const tempTerm = (tempExcess / 10) * 0.01;
    return 1 + altTerm + tempTerm;
  }

  function computeLiquidFactor(elevFt, tempF){
    const altExcessFt = Math.max(0, elevFt - 600);
    const altTerm = (altExcessFt / 1000) * 0.03;
    const tempExcess = Math.max(0, (tempF || 0) - 77);
    const tempTerm = (tempExcess / 10) * 0.0165;
    return 1 + altTerm + tempTerm;
  }

  // --------- Core calc ----------
  function recalc(){
    // Determine ZIP-based environment (elevation & temp)
    const zipRaw = (zipEl?.value || '').trim();
    let zipDigits = zipRaw.replace(/\D/g,'');
    let zipKey = '';
    if (zipDigits.length) {
      zipKey = zipDigits.padStart(5,'0').slice(-5);
    }

    let env = { elevFt:0, tempF:60, source:'default' };
    if (zipKey && ZIP_TABLE.size) {
      const row = ZIP_TABLE.get(zipKey);
      if (row) {
        env = { elevFt: row.elevFt, tempF: row.tempF, source:'zip' };
      } else {
        env.source = 'zip-missing';
      }
    } else if (zipKey && !ZIP_TABLE.size) {
      env.source = 'table-missing';
    }

    // NEC from sqft + branch circuits
    const sqft=parseInt(sqftEl?.value||'0',10)||0;
    const necLighting=Math.max(0, Math.round(sqft*3));
    const saQty=parseInt(smallQtyEl?.value||'0',10)||0;
    const laQty=parseInt(laundryQtyEl?.value||'0',10)||0;
    const branchW=(saQty+laQty)*1500;

    // Appliances: split unmanaged vs managed (largest)
    let nonLmsApplianceW=0; const managedGeneral=[];
    APPLIANCES.forEach(a=>{
      const cb=el('cb_'+a.id); if (!cb||!cb.checked) return;
      const runEl=el('run_'+a.id); const v=parseInt(runEl?.value,10);
      const run=Number.isFinite(v)?v:a.run;
      const lms=el('lms_'+a.id);
      const isManaged=(lmsEnableEl && lmsEnableEl.value==='yes') && lms && lms.checked;
      if (isManaged) managedGeneral.push(run); else nonLmsApplianceW+=run;
    });
    const largestManagedGeneral = managedGeneral.length ? Math.max(...managedGeneral) : 0;

    // A/C rows: sum unmanaged + largest managed
    let acUnmanaged=0; const acManaged=[];
    const acRows=Array.from(acRowsEl.querySelectorAll('.ac-row'));
    acRows.forEach((row,i)=>{
      const input=row.querySelector('.ac-subgrid input[type="number"]');
      const runA=input ? parseFloat(input.value||'0')||0 : 0;
      const runW=Math.round(runA*240);
      const lms=el(`lms_ac_${i}`);
      const isManaged=(lmsEnableEl && lmsEnableEl.value==='yes') && lms && lms.checked;
      if (isManaged) acManaged.push(runW); else acUnmanaged+=runW;
    });
    const acManagedMax = acManaged.length ? Math.max(...acManaged) : 0;
    const acEffective  = acUnmanaged + acManagedMax;

    // Heating candidate (uses AC effective if HP supplemental)
    const heatCandidate = getHeatCandidateW(acEffective);

    // Seasonal effective (one big thing at a time)
    const seasonalEffective = Math.max(acEffective, heatCandidate);

    // EV: sum unmanaged + largest managed
    let evUnmanaged=0; const evManaged=[];
    const evRows=Array.from((evPanel?.querySelector('#ev-rows')||document.createElement('div')).querySelectorAll('.ev-row'));
    evRows.forEach((row,i)=>{
      const input=row.querySelector('input[type="number"]');
      const amps=input ? parseFloat(input.value||'0')||0 : 0;
      const runW=Math.round(amps*240);
      const lms=el(`lms_ev_${i}`);
      const isManaged=(lmsEnableEl && lmsEnableEl.value==='yes') && lms && lms.checked;
      if (isManaged) evManaged.push(runW); else evUnmanaged+=runW;
    });
    const evManagedMax = evManaged.length ? Math.max(...evManaged) : 0;
    const evEffective  = evUnmanaged + evManagedMax;

    // Demand factor (NEC) for general non-AC
    const totalGeneral = necLighting + branchW + nonLmsApplianceW + largestManagedGeneral;
    const first10k=Math.min(totalGeneral,10000), remainder=Math.max(totalGeneral-10000,0);
    const weightedGeneral=first10k + Math.round(remainder*0.40);

    // Running watts (continuous)
    const runningWatts = weightedGeneral + seasonalEffective + evEffective;

    // Continuous amps BEFORE buffer, BEFORE derating
    const rawBuf = parseFloat(bufferPctEl?.value || '20');
    const bufferVal = Number.isFinite(rawBuf) ? rawBuf : 20;
    const buffer=Math.max(0, Math.min(50, bufferVal));
    const bufferFrac = buffer / 100;
    const baseRunningAmps = runningWatts / 240;

    // Inline headroom hint
    if (bufferHintEl) {
      if (!Number.isFinite(rawBuf)) {
        bufferHintEl.textContent = 'Default is 20%. Most homes use 10‚Äì30% headroom.';
        bufferHintEl.style.color = '#6b7280';
      } else if (rawBuf > 40) {
        bufferHintEl.textContent = 'Most homes use 10‚Äì30% headroom. Values above 40% are rarely needed.';
        bufferHintEl.style.color = '#b91c1c';
      } else {
        bufferHintEl.textContent = 'Default is 20%. Most homes use 10‚Äì30% headroom.';
        bufferHintEl.style.color = '#6b7280';
      }
    }

    // Surge amps via max-start swap (baseline, before derating)
    const msStartA=parseFloat(msStartAmpsEl?.value||'0')||0;
    const msRunA  =parseFloat(msRunAmpsEl?.value||'0')||0;
    const soft    =(msSoftEl?.value||'no')==='yes' ? 0.5 : 1.0;
    const preBufferAmps=baseRunningAmps;
    const surgeDeltaA=Math.max(0, (msStartA*soft) - msRunA);
    const baseSurgeAmps=preBufferAmps + surgeDeltaA;

    const fuel=(fuelEl?.value||'lp');

    // Helper: pick generator given assumed cooling type for derating
    function pickWithEnv(coolingHint){
      const elevFt = env.elevFt || 0;
      const tempF = env.tempF || 60;
      const factor = coolingHint === 'liquid'
        ? computeLiquidFactor(elevFt, tempF)
        : computeAirFactor(elevFt, tempF);

      const deratedRunAmps = baseRunningAmps * factor;
      const deratedSurgeAmps = baseSurgeAmps * factor;

      const neededAmps = deratedRunAmps / (1 - bufferFrac);
      const choice = pickGenerator(neededAmps, deratedSurgeAmps, fuel);

      return { factor, neededAmps, surgeAmps: deratedSurgeAmps, choice };
    }

    // First assume air-cooled (most common), then adjust if final choice is liquid-cooled
    let interim = pickWithEnv('air');
    let coolingType = (interim.choice && typeof interim.choice.cooling === 'string' && interim.choice.cooling.toLowerCase().startsWith('liquid'))
      ? 'liquid'
      : 'air';

    if (coolingType === 'liquid') {
      interim = pickWithEnv('liquid');
    }

    const neededAmps = interim.neededAmps;
    const surgeAmps = interim.surgeAmps;
    const choice = interim.choice;

    // Cooling note + LC advisory (hide if LMS is enabled)
    const isPortable = neededAmps <= 30;
    let coolingNote = '';
    if (!isPortable && choice && typeof choice.cooling === 'string' && choice.cooling.trim()){
      const c = choice.cooling.trim().toLowerCase();
      coolingNote = c.startsWith('liquid') ? ' ‚Äî Liquid-cooled' : ' ‚Äî Air-cooled';
    }
    const lcAlertEl = document.getElementById('lc-alert');
    const isLiquid  = (!isPortable && (
      (choice && typeof choice.cooling === 'string' && choice.cooling.toLowerCase().startsWith('liquid')) ||
      String(coolingNote).toLowerCase().includes('liquid-cooled')
    ));
    const lmsOn = (lmsEnableEl && lmsEnableEl.value === 'yes');
    if (lcAlertEl) lcAlertEl.style.display = (!lmsOn && isLiquid) ? 'block' : 'none';

    // Output
    runWEl.textContent = runningWatts.toLocaleString();
    needAEl.textContent = Math.ceil(neededAmps).toString();
    peakAEl.textContent = Math.ceil(surgeAmps).toString();
    recEl.textContent = `${choice.label} (${fuel==='lp'?'LP':'NG'})${coolingNote}`;

    // LMS summary tiles
    lmsMaxGeneralEl.textContent = `${largestManagedGeneral.toLocaleString()} W`;
    lmsMaxOthersEl.textContent  = `${Math.max(acManagedMax, evManagedMax).toLocaleString()} W`;

    // Env note (optional display)
    if (envNoteEl) {
      if (env.source === 'zip') {
        envNoteEl.textContent = `Derated for approx. elevation ${Math.round(env.elevFt)} ft and typical summer high ${Math.round(env.tempF)}¬∞F.`;
      } else if (env.source === 'zip-missing') {
        envNoteEl.textContent = `ZIP not found in table. Using default sea level and 60¬∞F.`;
      } else if (env.source === 'table-missing') {
        envNoteEl.textContent = `ZIP-based derating table not loaded. Using default sea level and 60¬∞F.`;
      } else {
        envNoteEl.textContent = '';
      }
    }

    // Maintain panel heights when open
    if (panel?.getAttribute('data-open')==='1') panel.style.maxHeight=panel.scrollHeight+'px';
    if (acPanel?.getAttribute('data-open')==='1') acPanel.style.maxHeight=acPanel.scrollHeight+'px';
    if (heatPanel?.getAttribute('data-open')==='1') heatPanel.style.maxHeight=heatPanel.scrollHeight+'px';
    if (lmsSectionEl?.getAttribute('data-open')==='1') lmsSectionEl.style.maxHeight=lmsSectionEl.scrollHeight+'px';
  }

  // --------- Wire-up ----------
  function updateSummaryAndCalc(){ updateSummary(); refreshLmsListDisabled(); recalc(); }

  scopeEl.addEventListener('change', e=>applyPreset(e.target.value));
  listEl.addEventListener('change', updateSummaryAndCalc);
  listEl.addEventListener('input',  updateSummaryAndCalc);
  sqftEl?.addEventListener('input', recalc);
  smallQtyEl?.addEventListener('input', recalc);
  laundryQtyEl?.addEventListener('input', recalc);
  addAcBtn.addEventListener('click', ()=>{ addAcRow(); setSection(acPanel,toggleAc,true,'details'); buildLmsList(); recalc(); });
  addEvBtn?.addEventListener('click', ()=>{ addEvRow(); setSection(evPanel,toggleEv,true,'details'); buildLmsList(); recalc(); });
  bufferPctEl?.addEventListener('input', recalc);
  fuelEl?.addEventListener('change', recalc);
  heatTypeEl?.addEventListener('change', ()=>{ buildLmsList(); recalc(); });
  heatKwEl?.addEventListener('input',  ()=>{ buildLmsList(); recalc(); });

  // Max-start listeners
  msStartAmpsEl?.addEventListener('input', recalc);
  msRunAmpsEl?.addEventListener('input', recalc);
  msVoltsEl?.addEventListener('change', recalc);
  msSoftEl?.addEventListener('change', recalc);

  // ZIP listener
  zipEl?.addEventListener('input', recalc);

  // LMS enable/disable
  lmsEnableEl?.addEventListener('change', ()=>{
    const on=lmsEnableEl.value==='yes';
    lmsSectionEl.setAttribute('data-open', on?'1':'0');
    lmsSectionEl.style.maxHeight = on ? (lmsSectionEl.scrollHeight + 'px') : '0';
    lmsToggleEl.textContent = on ? 'Hide details ‚ñ¥' : 'Show details ‚ñæ';
    refreshLmsListDisabled(); recalc();
  });

  // Stepper scroll behavior
  document.querySelectorAll('.flow-steps [data-step-target]').forEach(btn => {
    btn.addEventListener('click', () => {
      const targetSelector = btn.getAttribute('data-step-target');
      const target = targetSelector ? document.querySelector(targetSelector) : null;
      if (!target) return;

      const headerOffset = 80;
      const rect = target.getBoundingClientRect();
      const scrollTop = window.scrollY + rect.top - headerOffset;

      window.scrollTo({
        top: scrollTop,
        behavior: 'smooth',
      });
    });
  });

  // --------- Init ----------
  (async()=>{
    await Promise.all([tryLoadCsv(), tryLoadZipCsv()]);
    buildLmsList();
    applyGrid();
    applyPreset('essentials');
  })();
});
</script>
