---
/*
Calculator.astro — Fuel-based continuous amps + max-start surge check
(Updates:)
- "Other" unchecked by default
- Read Cooling from CSV and append "— Air-cooled" / "— Liquid-cooled" in recommendation,
  except when amps are in portable range (neededAmps ≤ 30A).
*/
---
<div class="box" id="gen-calculator">
  <div class="calc-grid">
    <div class="inputs">
      <label for="scope"><strong>What do you want to power?</strong></label>
      <select id="scope">
        <option value="essentials">Essentials (fridge, lights, furnace blower)</option>
        <option value="most">Most of house (kitchen + some HVAC)</option>
        <option value="whole">Whole house (unrestricted typical use)</option>
      </select>

      <div class="controls-row" style="margin-top:.5rem;align-items:end;">
        <div>
          <label for="sqft" class="lbl">Home square footage (incl. garage &amp; basement)</label>
          <input id="sqft" class="fld" type="number" min="0" step="50" placeholder="e.g., 2400">
          <small style="color:#666">NEC general lighting load = 3 watts per sq ft × this number. (NEC&nbsp;2023 includes garage &amp; basement.)</small>
        </div>
      </div>

      <!-- Collapsible appliance section -->
      <div id="appliance-header" style="display:flex;justify-content:space-between;align-items:center;margin-top:0.75rem;">
        <div id="appliance-summary" style="font-size:.95rem;color:#555">
          ✅ Preset applied. <span id="summary-count">0</span> items selected.
          <button id="toggle-appliances" type="button" aria-controls="appliance-panel" aria-expanded="false" style="margin-left:.5rem;border:0;background:transparent;color:#0b6;font-weight:600;cursor:pointer;">Show details ▾</button>
        </div>
      </div>

      <div id="appliance-panel" data-open="0" style="overflow:hidden;max-height:0;transition:max-height .28s ease;will-change:max-height;margin-top:.25rem;">
        <p style="margin:.25rem 0 .5rem;color:#666">Toggle what you’ll run at the same time. Edit <em>running watts</em> if you have the rating plate; defaults are typical values.</p>
        <!-- NEC required small-appliance and laundry circuits -->
        <div id="nec-circuits" style="display:grid;grid-template-columns:1fr auto auto;gap:.5rem 1rem;align-items:center;margin:.5rem 0 .75rem;">
          <div><strong>Small-appliance circuits</strong> <small style="color:#666">(NEC, 1500 W each)</small></div>
          <label for="smallQty" style="justify-self:end;color:#555">Qty</label>
          <input id="smallQty" type="number" min="0" step="1" value="2" style="width:7ch;text-align:right;">

          <div><strong>Laundry circuits</strong> <small style="color:#666">(NEC, 1500 W each)</small></div>
          <label for="laundryQty" style="justify-self:end;color:#555">Qty</label>
          <input id="laundryQty" type="number" min="0" step="1" value="1" style="width:7ch;text-align:right;">
        </div>

        <div id="appliance-list" style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem 1rem"></div>
      </div>

      <hr style="margin:1rem 0">

      <!-- AC module -->
      <div id="ac-section">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem">
          <strong>Air conditioning (optional)</strong>
          <div style="display:flex;gap:.5rem;align-items:center">
            <button id="toggle-ac" type="button" aria-controls="ac-panel" aria-expanded="false" style="border:0;background:transparent;color:#0a7e51;font-weight:600;cursor:pointer;">Show details ▾</button>
            <button id="add-ac" type="button">+ Add AC system</button>
          </div>
        </div>
        <small style="color:#555">Add one row per condenser (e.g., 3-ton up, 2-ton down).</small>
        <div id="ac-panel" data-open="0" style="overflow:hidden;max-height:0;transition:max-height .28s ease;will-change:max-height;margin-top:.5rem;">
          <div id="ac-rows" style="display:flex;flex-direction:column;gap:.75rem;margin-top:.5rem"></div>
        </div>
      </div>

      <!-- Heating (optional) -->
      <div id="heat-section" style="margin-top:1rem;">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem">
          <strong>Heating (optional)</strong>
          <button id="toggle-heat" type="button" aria-controls="heat-panel" aria-expanded="false" style="border:0;background:transparent;color:#0a7e51;font-weight:600;cursor:pointer;">Show details ▾</button>
        </div>
        <div id="heat-panel" data-open="0" style="overflow:hidden;max-height:0;transition:max-height .28s ease;will-change:max-height;margin-top:.5rem;">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;align-items:center">
            <label for="heat-type">Type</label>
            <select id="heat-type">
              <option value="none">None</option>
              <option value="resistance">Electric resistance (furnace/baseboards)</option>
              <option value="hp_supp">Heat pump + electric supplemental</option>
            </select>
            <label for="heat-kw">kW (if applicable)</label>
            <input id="heat-kw" type="number" min="0" step="0.5" placeholder="e.g., 10">
          </div>
          <small style="color:#555">Per NEC, we use the larger of heating or A/C. For heat pumps, we add 65% of supplemental heat.</small>
        </div>
      </div>

      <!-- Max starting amps (now used in surge check) -->
      <div id="maxstart-section" style="margin-top:1rem;">
        <strong>Appliance w/max starting amps</strong>
        <div class="controls-row" style="grid-template-columns:1fr 1fr;align-items:end;margin-top:.5rem;">
          <div>
            <label for="ms-start-amps" class="lbl">Starting amps</label>
            <input id="ms-start-amps" type="number" min="0" step="0.1" placeholder="e.g., 40">
          </div>
          <div>
            <label for="ms-run-amps" class="lbl">Running amps</label>
            <input id="ms-run-amps" type="number" min="0" step="0.1" placeholder="e.g., 8">
          </div>
        </div>
        <div class="controls-row" style="grid-template-columns:1fr 1fr; margin-top:.25rem;">
          <div>
            <label for="ms-volts" class="lbl">Voltage</label>
            <select id="ms-volts">
              <option value="120" selected>120 V</option>
              <option value="240">240 V</option>
            </select>
          </div>
          <div>
            <label for="ms-soft" class="lbl">Soft Starter</label>
            <select id="ms-soft">
              <option value="no" selected>No</option>
              <option value="yes">Yes</option>
            </select>
          </div>
        </div>
        <small class="muted">Used to adjust peak (surge) amps for the recommendation.</small>
      </div>

      <!-- Fuel & Buffer -->
      <div class="controls-row">
        <label for="fuelType" class="lbl">Fuel type</label>
        <select id="fuelType">
          <option value="lp" selected>LP (propane)</option>
          <option value="ng">Natural gas</option>
        </select>
      </div>
      <div class="controls-row">
        <label for="bufferPct" class="lbl">Headroom buffer (%)</label>
        <input id="bufferPct" type="number" min="0" max="50" step="1" value="20" class="fld">
      </div>

      <hr>
    </div><!-- /inputs -->

    <aside class="summary-card" aria-live="polite">
      <div id="results">
        <h3 class="summary-title" style="margin:.25rem 0 .5rem">Recommended generator size</h3>
        <p class="summary-big" style="font-size:1.4rem;line-height:1.2;margin:.25rem 0 .75rem"><span id="rec">—</span></p>
        <p style="margin:.25rem 0"><strong>Planning load:</strong> <span id="runW">0</span> W</p>
        <p style="margin:.25rem 0"><strong>Needed amps (with buffer):</strong> <span id="needA">0</span> A</p>
        <p style="margin:.25rem 0"><strong>Peak amps (with max-start):</strong> <span id="peakA">0</span> A</p>
        <small id="assumption-note" style="color:#666;display:block;margin-top:.25rem">
          Running amps = watts ÷ 240. Needed amps = running amps ÷ (1 − headroom%). Peak includes max-start swap (soft starter cuts start amps 50%).
        </small>
      </div>
    </aside>
  </div><!-- /calc-grid -->

  <p style="margin-top:1rem;color:#555">
    Heads up: This calculator is for general information only. Always consult a licensed electrician before buying or installing a generator.
  </p>
</div>

<style>
  .box { background: var(--card, #fff); padding: 1.5rem; border-radius: 12px; box-shadow: 0 3px 14px rgba(0,0,0,.06); max-width: 720px; margin: 0 auto 1.5rem; }
  label { display:block; margin-top: 1rem; font-weight: 600; }
  input, select { width: 100%; padding: .6rem .7rem; margin-top: .35rem; border: 1px solid #cfd6df; border-radius: 8px; font-size: 1rem; background:#fff; }
  .controls-row { display:grid; grid-template-columns: 1fr 1fr; gap:.5rem .75rem; margin-top:1rem; align-items:center; }
  .controls-row .lbl { font-weight:600; margin:0; }
  .controls-row .fld { width:100%; min-width:0; }
  @media (max-width:560px){ .controls-row { grid-template-columns: 1fr; } }
  .watt-input { width: 7ch; min-width: 7ch; text-align: right; padding:.35rem .5rem; margin:0; }
  .appliance-row { display:flex; align-items:center; gap:.5rem; }
  .appliance-row small { color:#666; }
  .appliance-row .name { flex: 1 1 auto; min-width: 0; }
  .calc-grid{display:grid;gap:1rem}
  @media(min-width:900px){.calc-grid{grid-template-columns:1fr 320px}}
  .summary-card{position:sticky;top:1rem;align-self:start;background:var(--card,#fff);border:1px solid #e6ebf2;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.06);padding:1rem}
  .summary-card p{margin:.25rem 0}
  .summary-card strong{font-weight:700}
  #toggle-appliances{color:#0a7e51}
  #toggle-appliances:hover{text-decoration:underline}
  .muted{ color:#6b7280 }
  .ac-subgrid{ display:grid; grid-template-columns: 1fr; gap:.5rem .75rem; margin-top:.35rem; }
  .ac-subgrid input{ width: 9ch; text-align:right; }
</style>

<script>
window.addEventListener('DOMContentLoaded', () => {
  // ---------- APPLIANCES (non-AC) ----------
  const APPLIANCES = [
    { id:'well',        name:'Well pump (3/4 hp)',              run:1500, defaultScopes:['most','whole'] },
    { id:'sump',        name:'Sump pump (1/2 hp)',              run:900,  defaultScopes:['essentials','most','whole'] },
    { id:'freezer',     name:'Chest freezer',                   run:120,  defaultScopes:['most','whole'] },
    { id:'microwave',   name:'Microwave (1.0–1.2 kW)',          run:1200, defaultScopes:['most','whole'] },
    { id:'disposal',    name:'Garbage disposal',                run:700,  defaultScopes:['most','whole'] },
    { id:'dishwasher',  name:'Dishwasher',                      run:1500, defaultScopes:['most','whole'] },
    { id:'elecRange',   name:'Electric range (cooktop+oven)',   run:8000, defaultScopes:['whole'] },
    { id:'wallOven',    name:'Wall-mounted oven (single)',      run:3000, defaultScopes:['whole'] },
    { id:'cooktop',     name:'Counter cooktop (electric)',      run:3500, defaultScopes:['whole'] },
    { id:'waterHeater', name:'Electric water heater (tank)',    run:4500, defaultScopes:['whole'] },
    { id:'elecDryer',   name:'Electric clothes dryer',          run:5500, defaultScopes:['whole'] },
    { id:'gdoor',       name:'Garage door opener',              run:500,  defaultScopes:['most','whole'] },
    { id:'septic',      name:'Septic grinder pump',             run:1000, defaultScopes:['most','whole'] },
    { id:'hottub',      name:'Hot tub / spa',                   run:10000,defaultScopes:['whole'] },
    { id:'pool',        name:'Pool pump (1–1.5 hp)',            run:1200, defaultScopes:[] }, // always unchecked
    { id:'other',       name:'Other (enter watts)',             run:0,    defaultScopes:[] }, // ← now unchecked by default
    { id:'fridge',      name:'Refrigerator',                    run:150,  defaultScopes:['essentials','most','whole'] },
    { id:'furnace',     name:'Furnace blower (gas/propane)',    run:600,  defaultScopes:['essentials','most','whole'] }
  ];

  // ---------- AC assumptions (for prefill of RUN amps only) ----------
  const RUN_W_PER_TON = { standard: 1100, inverter: 750 };
  const AC_VOLTS = 240;

  // ---------- Fallback generator table (amps @ 240) ----------
  // Will be overridden by CSV if found.
  let GEN_TABLE = [
    { label:'~10 kW standby', amps_lp:42, amps_ng:42, max_surge:55, cooling:'Air' },
    { label:'~14 kW standby', amps_lp:58, amps_ng:54, max_surge:75, cooling:'Air' },
    { label:'~18 kW standby', amps_lp:75, amps_ng:70, max_surge:90, cooling:'Air' },
    { label:'~22 kW standby', amps_lp:92, amps_ng:81, max_surge:110, cooling:'Air' },
    { label:'~24 kW standby', amps_lp:100, amps_ng:100, max_surge:120, cooling:'Air' },
    { label:'~26 kW standby', amps_lp:108, amps_ng:108, max_surge:130, cooling:'Air' }
  ];

  // Try to load CSV if present
  async function tryLoadCsv() {
    const paths = ['/generator-amps.csv','/data/generator-amps.csv','/generator_amps.csv','/public/generator_amps.csv'];
    for (const p of paths) {
      try {
        const res = await fetch(p, { cache:'no-store' });
        if (!res.ok) continue;
        const text = await res.text();
        const rows = text.trim().split(/\r?\n/);
        const header = rows.shift().split(',').map(s=>s.trim().toLowerCase());
        const iLabel   = header.indexOf('label');
        const iLP      = header.indexOf('amps_lp');
        const iNG      = header.indexOf('amps_ng');
        const iSurge   = header.indexOf('max_surge');
        const iCooling = header.indexOf('cooling'); // optional
        if (iLabel === -1 || iLP === -1 || iNG === -1 || iSurge === -1) continue;

        const parsed = rows.map(r=>{
          const cols = r.split(',').map(s=>s.trim());
          return {
            label: cols[iLabel],
            amps_lp: Number(cols[iLP]),
            amps_ng: Number(cols[iNG]),
            max_surge: Number(cols[iSurge]),
            cooling: iCooling >= 0 ? cols[iCooling] : undefined
          };
        }).filter(x =>
          x.label &&
          Number.isFinite(x.amps_lp) &&
          Number.isFinite(x.amps_ng) &&
          Number.isFinite(x.max_surge)
        );

        if (parsed.length) {
          GEN_TABLE = parsed.sort((a,b)=>Math.min(a.amps_lp,a.amps_ng)-Math.min(b.amps_lp,b.amps_ng));
        }
        break;
      } catch(e){ /* ignore; fall back to inline */ }
    }
  }

  // ---------- Elements ----------
  const el = (id) => document.getElementById(id);
  const scopeEl      = el('scope');
  const listEl       = el('appliance-list');
  const runWEl       = el('runW');
  const needAEl      = el('needA');
  const peakAEl      = el('peakA');
  const sqftEl       = el('sqft');
  const smallQtyEl   = el('smallQty');
  const laundryQtyEl = el('laundryQty');
  const recEl        = el('rec');
  const bufferPctEl  = el('bufferPct');
  const fuelEl       = el('fuelType');
  const acRowsEl     = el('ac-rows');
  const addAcBtn     = el('add-ac');
  const heatTypeEl   = el('heat-type');
  const heatKwEl     = el('heat-kw');
  const acPanel      = document.getElementById('ac-panel');
  const heatPanel    = document.getElementById('heat-panel');
  const toggleAc     = document.getElementById('toggle-ac');
  const toggleHeat   = document.getElementById('toggle-heat');
  const panel        = el('appliance-panel');
  const toggleBtn    = el('toggle-appliances');
  const summaryCount = el('summary-count');

  // Max-start fields (used now)
  const msStartAmpsEl = el('ms-start-amps');
  const msRunAmpsEl   = el('ms-run-amps');
  const msVoltsEl     = el('ms-volts');
  const msSoftEl      = el('ms-soft');

  // Build appliance rows with "(W run)" after name
  APPLIANCES.forEach(a => {
    const wrap = document.createElement('label');
    wrap.className = 'appliance-row';

    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.id = 'cb_' + a.id;

    const nameSpan = document.createElement('span');
    nameSpan.className = 'name';
    nameSpan.textContent = a.name;

    const runUnit = document.createElement('small');
    runUnit.textContent = ' (W run)';

    const runInput = document.createElement('input');
    runInput.type = 'number';
    runInput.id = 'run_' + a.id;
    runInput.className = 'watt-input';
    runInput.min = '0';
    runInput.step = '10';
    runInput.value = a.run;
    runInput.setAttribute('aria-label', a.name + ' running watts');
    runInput.title = 'Running watts';

    wrap.appendChild(cb);
    wrap.appendChild(nameSpan);
    wrap.appendChild(runUnit);
    wrap.appendChild(runInput);

    listEl.appendChild(wrap);
    runInput.addEventListener('input', recalc);
  });

  // Responsive grid
  const media = window.matchMedia('(max-width: 520px)');
  function applyGrid(){ listEl.style.gridTemplateColumns = media.matches ? '1fr' : '1fr 1fr'; }
  applyGrid();
  if (media.addEventListener) media.addEventListener('change', applyGrid); else if (media.addListener) media.addListener(applyGrid);

  // Collapsible helpers
  let open = false;
  function setPanel(openNow){ open = openNow; panel.setAttribute('data-open', open ? '1' : '0'); toggleBtn.setAttribute('aria-expanded', open ? 'true' : 'false'); panel.style.maxHeight = open ? panel.scrollHeight + 'px' : '0'; toggleBtn.textContent = open ? 'Hide details ▴' : 'Show details ▾'; }
  function setSection(panelEl, toggleEl, openNow){ if (!panelEl || !toggleEl) return; panelEl.setAttribute('data-open', openNow ? '1' : '0'); toggleEl.setAttribute('aria-expanded', openNow ? 'true' : 'false'); panelEl.style.maxHeight = openNow ? panelEl.scrollHeight + 'px' : '0'; toggleEl.textContent = openNow ? 'Hide details ▴' : 'Show details ▾'; }
  toggleBtn.addEventListener('click', () => setPanel(!open));
  toggleAc?.addEventListener('click', ()=> setSection(acPanel, toggleAc, (acPanel?.getAttribute('data-open')!=='1')));
  toggleHeat?.addEventListener('click', ()=> setSection(heatPanel, toggleHeat, (heatPanel?.getAttribute('data-open')!=='1')));

  // AC rows (running amps only)
  function prefillRunAmps(tons, type){
    const runW = Math.max(0, tons) * (RUN_W_PER_TON[type] || RUN_W_PER_TON.standard);
    return Math.round((runW / AC_VOLTS) * 10) / 10;
  }
  function addAcRow(preset = { tons: 2.5, type: 'standard' }){
    if (acRowsEl.children.length >= 3) return;

    const row = document.createElement('div');
    row.className = 'ac-row';
    row.style.display = 'grid';
    row.style.gridTemplateColumns = '1fr 1fr auto';
    row.style.gap = '.5rem';
    row.style.alignItems = 'center';
    row.style.padding = '.25rem .25rem .5rem';
    row.style.border = '1px solid #eef2f6';
    row.style.borderRadius = '8px';

    const tonSel = document.createElement('select');
    [1.5,2,2.5,3,3.5,4,5].forEach(t=>{ const opt=document.createElement('option'); opt.value=t; opt.textContent=`${t} ton`; tonSel.appendChild(opt); });
    tonSel.value = preset.tons;

    const typeSel = document.createElement('select');
    [{v:'standard', n:'Standard (single-stage)'},{v:'inverter', n:'High-efficiency (inverter)'}].forEach(o=>{ const opt=document.createElement('option'); opt.value=o.v; opt.textContent=o.n; typeSel.appendChild(opt); });
    typeSel.value = preset.type;

    const delBtn = document.createElement('button'); delBtn.type = 'button'; delBtn.textContent = '✕'; delBtn.title = 'Remove'; delBtn.style.minWidth = '2rem';

    const sub = document.createElement('div');
    sub.className = 'ac-subgrid';
    sub.style.gridColumn = '1 / -1';
    const runLbl = document.createElement('label'); runLbl.textContent = 'Running amps';
    const runA   = document.createElement('input'); runA.type = 'number'; runA.step = '0.1'; runA.min = '0';

    sub.appendChild(runLbl);
    sub.appendChild(runA);

    const typeWrap = document.createElement('div'); typeWrap.appendChild(typeSel);
    row.appendChild(tonSel);
    row.appendChild(typeWrap);
    row.appendChild(delBtn);
    row.appendChild(sub);
    acRowsEl.appendChild(row);

    function refreshRunDefault(){ runA.value = prefillRunAmps(parseFloat(tonSel.value)||0, typeSel.value); }
    refreshRunDefault();

    const recalcBound = recalc.bind(null);
    tonSel.addEventListener('change', ()=>{ refreshRunDefault(); recalcBound(); });
    typeSel.addEventListener('change', ()=>{ refreshRunDefault(); recalcBound(); });
    runA.addEventListener('input', recalcBound);
    delBtn.addEventListener('click', ()=>{ row.remove(); recalc(); });
  }

  // Heating helper (unchanged)
  function getHeatCandidateW(acRun){
    const type = heatTypeEl ? heatTypeEl.value : 'none';
    const kw = parseFloat(heatKwEl && heatKwEl.value ? heatKwEl.value : '0') || 0;
    if (type === 'resistance') return Math.round(kw * 1000);
    if (type === 'hp_supp') { const supp = Math.round(kw * 1000 * 0.65); return acRun + supp; }
    return 0;
  }

  function updateSummary(){
    const count = APPLIANCES.filter(a => document.getElementById('cb_'+a.id).checked).length;
    summaryCount.textContent = count;
  }

  function applyPreset(scope){
    APPLIANCES.forEach(a => { const cb = document.getElementById('cb_' + a.id); if (cb) cb.checked = false; });
    APPLIANCES.filter(a => a.defaultScopes.includes(scope))
      .forEach(a => { const cb = document.getElementById('cb_' + a.id); if (cb) cb.checked = true; });

    if (scope === 'essentials') { ['spaceHeat','waterHeater','elecRange','elecDryer'].forEach(id=>{ const c = document.getElementById('cb_'+id); if (c) c.checked = false; }); }
    if (scope === 'most') { ['waterHeater','elecDryer','elecRange'].forEach(id=>{ const c = document.getElementById('cb_'+id); if (c) c.checked = false; }); }
    { const c = document.getElementById('cb_hottub'); if (c) c.checked = false; }

    acRowsEl.innerHTML = '';
    setSection(acPanel, toggleAc, false);
    setSection(heatPanel, toggleHeat, false);

    if (smallQtyEl) smallQtyEl.value = '2';
    if (laundryQtyEl) laundryQtyEl.value = '1';
    updateSummary(); setPanel(false); recalc();
  }

  // --- Pick generator: must meet BOTH continuous and surge amps ---
  function pickGenerator(neededAmps, surgeAmps, fuel /* 'lp' | 'ng' */){
    const key = fuel === 'ng' ? 'amps_ng' : 'amps_lp';

    // 1) Filter by CONTINUOUS first (fuel-specific)
    const contOK = GEN_TABLE.filter(row => Number(row[key]) >= neededAmps);

    if (contOK.length === 0) {
      return {
        label: `≥ ${Math.ceil(neededAmps)} A continuous (custom)`,
        amps_lp: neededAmps, amps_ng: neededAmps, max_surge: surgeAmps
      };
    }

    // 2) Sort by the same fuel-specific amps so we truly get the smallest that works
    contOK.sort((a, b) => Number(a[key]) - Number(b[key]));

    // 3) Among those, pick the smallest that also meets SURGE
    const bothOK = contOK.find(row => Number(row.max_surge) >= surgeAmps);
    if (bothOK) return bothOK;

    // 4) If none meet surge, take the smallest that meets continuous (honest upsize path)
    return contOK[0];
  }

  function recalc(){
    let runSumNonAC = 0;

    // NEC lighting from sqft
    const sqft = parseInt(sqftEl?.value || '0', 10) || 0;
    const necLighting = Math.max(0, Math.round(sqft * 3));
    runSumNonAC += necLighting;

    // NEC branch circuits
    const saQty = parseInt(smallQtyEl?.value || '0', 10) || 0;
    const laQty = parseInt(laundryQtyEl?.value || '0', 10) || 0;
    runSumNonAC += (saQty + laQty) * 1500;

    // Appliances
    APPLIANCES.forEach(a => {
      const cb = document.getElementById('cb_'+a.id);
      if (!cb || !cb.checked) return;
      const runEl = document.getElementById('run_'+a.id);
      const v = parseInt(runEl?.value, 10);
      const run = Number.isFinite(v) ? v : a.run;
      runSumNonAC += run;
    });

    // AC loads from RUNNING AMPS (A×240)
    let acRun = 0;
    const acRows = Array.from(acRowsEl.querySelectorAll('.ac-row'));
    acRows.forEach(row => {
      const sub = row.querySelector('.ac-subgrid');
      const input = sub ? sub.querySelector('input[type="number"]') : null;
      const runA = input ? parseFloat(input.value || '0') || 0 : 0;
      acRun += Math.round(runA * AC_VOLTS);
    });

    // Heating vs AC seasonal selection
    const heatCandidate = getHeatCandidateW(acRun);
    const seasonalMax = Math.max(acRun, heatCandidate);

    // General (NEC) demand factor for non-AC
    const totalGeneral = runSumNonAC;
    const first10k = Math.min(totalGeneral, 10000);
    const remainder = Math.max(totalGeneral - 10000, 0);
    const weightedGeneral = first10k + Math.round(remainder * 0.40);

    // Base running watts (continuous only)
    const runningWatts = weightedGeneral + seasonalMax;

    // Running & needed amps (continuous)
    const buffer = Math.max(0, Math.min(50, parseInt(bufferPctEl?.value || '20', 10) || 20));
    const runningAmps = runningWatts / 240;
    const neededAmps  = runningAmps / (1 - buffer/100);

    // Peak (surge) amps = pre-buffer amps, swapping raw amps (no voltage normalization)
// Matches: peak = runningAmps_preBuffer − msRunA + (msStartA * soft)
const msStartA = parseFloat(msStartAmpsEl?.value || '0') || 0;
const msRunA   = parseFloat(msRunAmpsEl?.value || '0') || 0;
// keep the field but don't use it in the math per your spec/Excel
// const msV   = parseInt(msVoltsEl?.value || '120', 10) || 120;
const soft     = (msSoftEl?.value || 'no') === 'yes' ? 0.5 : 1.0;

const preBufferAmps = runningWatts / 240;           // = runningAmps before headroom
const surgeDeltaA   = Math.max(0, (msStartA * soft) - msRunA);
const surgeAmps     = preBufferAmps + surgeDeltaA;  // what we display + compare to max_surge


    // Pick generator
    const fuel = (fuelEl?.value || 'lp');
    const choice = pickGenerator(neededAmps, surgeAmps, fuel);

    // Build cooling note (show only if NOT portable-level amps)
    const isPortable = neededAmps <= 30; // ≈7.2 kW @ 240V — rule-of-thumb portable threshold
    let coolingNote = '';
    if (!isPortable && choice && typeof choice.cooling === 'string' && choice.cooling.trim()) {
      const c = choice.cooling.trim().toLowerCase();
      coolingNote = c.startsWith('liquid') ? ' — Liquid-cooled' : ' — Air-cooled';
    }

    // Output
    runWEl.textContent  = runningWatts.toLocaleString();
    needAEl.textContent = Math.ceil(neededAmps).toString();
    peakAEl.textContent = Math.ceil(surgeAmps).toString();
    recEl.textContent   = `${choice.label} (${fuel === 'lp' ? 'LP' : 'NG'})${coolingNote}`;

    // Maintain panel heights when open
    if (panel?.getAttribute('data-open') === '1') panel.style.maxHeight = panel.scrollHeight + 'px';
    if (acPanel?.getAttribute('data-open') === '1') acPanel.style.maxHeight = acPanel.scrollHeight + 'px';
    if (heatPanel?.getAttribute('data-open') === '1') heatPanel.style.maxHeight = heatPanel.scrollHeight + 'px';
  }

  // Wire-up
  scopeEl.addEventListener('change', e => applyPreset(e.target.value));
  listEl.addEventListener('change', () => { updateSummary(); recalc(); });
  listEl.addEventListener('input', recalc);
  sqftEl?.addEventListener('input', recalc);
  smallQtyEl?.addEventListener('input', recalc);
  laundryQtyEl?.addEventListener('input', recalc);
  addAcBtn.addEventListener('click', () => { addAcRow(); setSection(acPanel, toggleAc, true); recalc(); });
  bufferPctEl?.addEventListener('input', recalc);
  fuelEl?.addEventListener('change', recalc);
  heatTypeEl?.addEventListener('change', recalc);
  heatKwEl?.addEventListener('input', recalc);

  // Max-start listeners
  msStartAmpsEl?.addEventListener('input', recalc);
  msRunAmpsEl?.addEventListener('input', recalc);
  msVoltsEl?.addEventListener('change', recalc);
  msSoftEl?.addEventListener('change', recalc);

  // Init
  (async () => {
    await tryLoadCsv();     // pulls your generator(-|_)amps.csv (with max_surge, optional Cooling)
    applyPreset('essentials');
  })();
});
</script>
